# MEMORY.md — 三國志 NES ROM 逆向工程研究記錄

## ROM 概要

| 項目 | 值 |
|------|------|
| 檔名 | `Sangokushi__Japan_.nes` |
| Mapper | 1 (MMC1) |
| PRG ROM | 256 KB = 16 banks × 16 KB |
| PRG 偏移 | 0x00010 – 0x4000F (扣除 16-byte iNES header) |
| CHR ROM | 0 KB (CHR-RAM, tile 資料存於 PRG ROM) |
| Bank 換算 | 檔案偏移 = bank × 0x4000 + 0x10 |

---

## 武將資料表 (已完成解析)

### 位置
- 所在 Bank: 14 (檔案偏移 0x38010–0x3C00F)
- 表頭: 0x38010–0x38013 = `4C 00 00 00` (0x4C = 76)
- 資料起始: 0x38014
- 記錄數: 256 筆
- 資料結束: 0x39113

### 記錄結構 (17 bytes/筆)

```
Offset  Size  欄位             說明
+0      1     Age (signed)     年齡, signed byte. 正=遊戲開始時年齡, 負=尚未出生
+1      1     Body             體力 (15–100), 推測為壽命/健康度
+2      1     Intelligence     智力 (15–100) ✓已驗證
+3      1     Military         武力 (15–100) ✓已驗證
+4      1     Charisma         魅力 (15–100) ✓已驗證
+5      1     Luck             運氣? (15–100), 用途未確認
+6      1     Loyalty          忠誠 (12–100), 君主固定100
+7      1     Status+Navy      複合 bitfield:
                                 bit0 = 水軍旗標 (1=水軍) ✓已驗證
                                 bit1 = 統領旗標 (1=君主或軍師)
                                 組合: 0=一般非水軍, 1=一般水軍,
                                       2=統領非水軍(軍師), 3=統領水軍(君主)
+8,+9   2     Troops (LE16)    兵士數, little-endian ✓已驗證
+10     1     City             城市 ID (0–55), 0=未配置
+11     1     Faction          勢力 ID (0–14), 0=無勢力
+12–16  5     Separator        固定 0A 0A 0A 00 00
```

### 統計
- 水軍 151 人 / 非水軍 105 人
- 統領 15 人 (12 君主 + 3 軍師)
- 負年齡 (未出生) 12 人

### 勢力對照 (推斷)
| Faction | 勢力 | 起始記錄 |
|---------|------|----------|
| 1 | 曹操 | #0, #1 |
| 2 | 孫堅 | #2 |
| 3 | 劉備 | #3 |
| 4 | 袁紹 | #4 |
| 5 | 袁術 | #5 |
| 6 | 劉表 | #6 |
| 7 | 董卓 | #7 |
| 8 | 劉焉 | #8 |
| 9 | 馬騰 | #9 |
| 10 | 公孫瓚 | #10 |
| 11 | 陶謙 | #141 |
| 12–14 | 其他 | — |

### 未確認欄位
- **B1 (Body)**: 範圍 15–100, 推測壽命或健康度, 需要更多遊戲驗證
- **B5 (Luck)**: 範圍 15–100, 可能是運氣/義理, 需要更多遊戲驗證
- **B0 (Age)**: 確認為年齡, 但表頭的 0x4C=76 意義不明 (可能為初始可用武將數?)

### 分隔符分析 (+12–16, 5 bytes)

**觀察結果:**
- 所有 256 筆武將記錄的分隔符都是 `0A 0A 0A 00 00`，完全相同
- ROM 中只有一個 17-byte 記錄表結構（武將資料表本身）
- 未發現其他平行的舞台配置表

**假設檢驗: 5 bytes 對應 5 個遊戲舞台?**
- 遊戲有 5 個舞台，武將在不同舞台可能有不同狀態（未登場/已登場/死亡）
- 若此假設成立，每個武將應該有不同的值，但實際上所有記錄都相同
- **結論: 此假設不成立**

**可能的解釋:**
1. 這 5 bytes 確實只是結構標記/填充，用於記錄對齊或結束標記
2. 舞台配置資料存在 RAM 而非 ROM（遊戲啟動時根據選擇的舞台動態設定）
3. 舞台差異資料使用不同結構儲存在 ROM 其他位置（如差分資料）

**補充統計:**
- 城市=0 且 勢力=0 的武將: 75 人（可能為在野或尚未登場）
- 這些武將的登場狀態可能由遊戲程式根據舞台動態決定

---

## 武將姓名對照 (已完成)

透過外部資料「光榮三國志系列武將登場統計 - 能力表.csv」的 S01 欄位，以五項能力值 (體力/智力/武力/魅力/運勢) 進行比對，成功匹配 **255/256** 筆武將姓名。

匹配方式: ROM 記錄的 (Body, Intelligence, Military, Charisma, Luck) 與外部 CSV 的 S01 能力值完全一致。

| 項目 | 數量 |
|------|------|
| 總記錄數 | 256 |
| 成功匹配 | 255 |
| 未匹配 | 1 (Index 0, 能力值 88/90/91/97/90, 可能為自訂君主) |

詳細對照請參考匯出的 CSV/XLSX 檔案。

---

## 武將姓名表 (已完成解析)

### 位置
- 所在 Bank: 14 (與武將資料表同 Bank)
- 表頭: 0x3A310–0x3A313 = `4C 00 00 00` (與武將資料表相同)
- 資料起始: 0x3A314
- 記錄數: 257 筆 (包含索引 0 的新君主模板)
- 資料結束: 約 0x3B824

### 記錄結構 (15 bytes/筆)

```
Offset  Size  欄位             說明
+0      8     Name             假名 (半角片假名, Shift-JIS 0xA6–0xDF)
                               以 0x00 結尾，不足 8 bytes 則填充 0x00
+8      1     Kanji1 TileID    第一個漢字的 tile ID ✓已驗證
+9      1     Kanji1 Page      漢字 Page 指示器 (0=Page0, 1=Page1)
+10     1     Kanji2 TileID    第二個漢字的 tile ID ✓已驗證
+11     1     Kanji2 Page      漢字 Page 指示器
+12     1     Kanji3 TileID    第三個漢字的 tile ID ✓已驗證 (複姓用)
+13     1     Kanji3 Page      漢字 Page 指示器
+14     1     Portrait         頭像索引 byte (portrait = byte - 1) ✓已驗證
```

**漢字 tile ID 說明:**
- 每個武將姓名最多 3 個漢字 (位於 +8, +10, +12)
- Tile ID 對應遊戲內 CHR-RAM 中的漢字圖形
- 共發現 238 個不同的漢字 tile ID
- 詳細對照表見下方「漢字 Tile 對照表」章節

### 編碼說明

假名使用 **Shift-JIS 半角片假名** 編碼 (0xA6–0xDF):
- 清音: ｱ(0xB1) ｲ(0xB2) ｳ(0xB3) ｴ(0xB4) ｵ(0xB5) ...
- 濁音: 基本假名 + ﾞ(0xDE), 如 ｶﾞ = 0xB6 0xDE
- 半濁音: 基本假名 + ﾟ(0xDF), 如 ﾊﾟ = 0xCA 0xDF
- 拗音: 小字 ｬ(0xAC) ｭ(0xAD) ｮ(0xAE) ｯ(0xAF)

### 比對結果

| 索引 | ROM 假名 | 對應漢字 |
|------|----------|----------|
| 0 | ｿｳｿｳ | (新君主模板?) |
| 1 | ｿｳｿｳ | 曹操 |
| 2 | ｿﾝｹﾝ | 孫堅 |
| 3 | ﾘｭｳﾋﾞ | 劉備 |
| 4 | ｴﾝｼｮｳ | 袁紹 |
| 5 | ｴﾝｼﾞｭﾂ | 袁術 |
| 6 | ﾘｭｳﾋｮｳ | 劉表 |
| 7 | ﾄｳﾀｸ | 董卓 |
| 8 | ﾘｭｳｴﾝ | 劉焉 |
| 9 | ﾊﾞﾄｳ | 馬騰 |
| 10 | ｺｳｿﾝｻﾝ | 公孫瓚 |
| ... | ... | ... |

與外部 CSV 比對成功率: **249/257** (96.9%)

---

## 假名字體 tile (已定位)

### 位置
- 所在 Bank: 8 (檔案偏移 0x20010–0x24010)
- 字體起始: 0x22CA0
- Tile 大小: 8×8 pixels, 16 bytes/tile

### 字體特徵
- 每個假名 tile 包含陰影效果 (上半部分淡色, 下半部分深色)
- 可能用於遊戲中的人名顯示

### 五十音對照表 (推測)
從 0x22CA0 開始，tile 按五十音順序排列:
```
Tile  0 = ア   Tile 10 = サ   Tile 20 = ナ   Tile 30 = マ   Tile 40 = ラ
Tile  1 = イ   Tile 11 = シ   Tile 21 = ニ   Tile 31 = ミ   Tile 41 = リ
Tile  2 = ウ   Tile 12 = ス   Tile 22 = ヌ   Tile 32 = ム   Tile 42 = ル
Tile  3 = エ   Tile 13 = セ   Tile 23 = ネ   Tile 33 = メ   Tile 43 = レ
Tile  4 = オ   Tile 14 = ソ   Tile 24 = ノ   Tile 34 = モ   Tile 44 = ロ
Tile  5 = カ   Tile 15 = タ   Tile 25 = ハ   Tile 35 = ヤ   Tile 45 = ワ
Tile  6 = キ   Tile 16 = チ   Tile 26 = ヒ   Tile 36 = ユ   Tile 46 = ヲ
Tile  7 = ク   Tile 17 = ツ   Tile 27 = フ   Tile 37 = ヨ   Tile 47 = ン
Tile  8 = ケ   Tile 18 = テ   Tile 28 = ヘ   Tile 38 = ...
Tile  9 = コ   Tile 19 = ト   Tile 29 = ホ   Tile 39 = ...
```

濁點 (゛) 和半濁點 (゜) 可能在 tile 45 之後。

---

## 漢字 Tile 對照表 (已完成解析)

### 圖形儲存位置 (已確認)

透過 Mesen debugger 追蹤，確認漢字 tile 圖形的 ROM 位置：

```
PRG_ROM_offset = 0x205E4 + (tile_id + 0x30) × 16
File_offset = PRG_ROM_offset + 0x10
```

- **基址 (PRG ROM)**: `0x205E4`
- **基址 (檔案)**: `0x205F4`
- **所在 Bank**: 8 (0x20010–0x2400F)
- **每個漢字**: 64 bytes (4 個 8×8 tiles)
- **PPU 偏移**: `+0x30` (tile_id + 0x30 = PPU tile index)

### 統計
- Page 0: **241** 個不同的漢字 tile ID (0x01-0xFF)
- Page 1: **67** 個擴展漢字 (0x01-0x42, 需 +9/+11/+13 flag)
- 總計: **308** 個漢字

### 部分對照表 (依 tile ID 排序)

```
ID   漢字    ID   漢字    ID   漢字    ID   漢字    ID   漢字
0x01 翊     0x10 王     0x24 關     0x3E 堅     0x55 司
0x02 苞     0x11 黃     0x25 韓     0x3F 憲     0x5A 慈
0x03 允     0x12 樊     0x26 玩     0x40 權     0x6E 諸
0x04 紘     0x13 稠     0x27 雍     0x41 謙     0x6F 徐
0x05 羽     0x14 軫     0x28 曠     0x43 嚴     0x8D 操
0x06 熙     0x15 夏     0x29 翔     0x44 玄     0x8E 曹
0x07 叡     0x16 華     0x2A 紀     0x45 胡     0x91 孫
0x08 蔡     0x17 旻     0x2B 儀     0x46 顧     0x92 遜
0x09 永     0x18 陶     0x2C 宜     0x47 吳     0x9F 張
0x0A 琦     0x19 璋     0x2D 休     0x4A 公     0xA0 超
0x0B 琮     0x1A 沛     0x2E 宮     0x4B 孔     0xA1 陳
0x0C 越     0x1B 郭     0x2F 玠     0x4C 洪     0xAB 董
0x0D 延     0x1C 懿     0x30 許     0x4D 晃     0xB6 馬
0x0E 應     0x1D 龐     0x31 顗     0x50 高     0xBD 備
0x0F 汜     0x1E 桓     0x32 興     0x51 綱     0xE3 劉
0x10 王     0x1F 于     0x33 欽     0x52 濟     0xE5 亮
...
```

### 驗證範例

| 索引 | 假名 | Tile IDs (hex) | 解碼漢字 | 外部比對 |
|------|------|----------------|----------|----------|
| 1 | ｿｳｿｳ | 8E 8D | 曹操 | ✓ |
| 2 | ｿﾝｹﾝ | 91 3E | 孫堅 | ✓ |
| 3 | ﾘｭｳﾋﾞ | E3 BD | 劉備 | ✓ |
| 174 | ｼｮｶﾂﾘｮｳ | 6E E5 | 諸亮 | ✓ (諸葛亮，葛字可能省略) |

完整對照表定義於 `sangokushi_extract_v2.py` 的 `KANJI_TILE_MAP` 常數中。

---

## 頭像系統 (已完成)

### 概要
- 總共 **81** 個主要頭像 (獨立 tile 資料)
- 每個頭像 = 6×6 tiles = 48×48 pixels
- Tile 資料存放於 PRG ROM Banks 4-6
- 256 個武將共用這些頭像 (多人共用同一頭像)

### 頭像指標表

**位置**: `0x1BC38` (81 entries × 4 bytes = 324 bytes)

每筆記錄結構:
```
Offset  Size  欄位
+0      1     Bank          資料所在 bank (4-6)
+1      1     TileCount     tile 數量 (28-36)
+2      2     Address       bank 內位址 (little-endian, $8xxx)
```

檔案偏移計算: `file_offset = bank × 0x4000 + (addr - 0x8000) + 0x10`

### 武將→頭像映射 (已解決)

**位置**: 姓名表每筆記錄的 byte 14

```
portrait_index = name_record[+14] - 1
```

範圍: 0-80 (共 81 個頭像)

### Tile 排列系統

頭像分為兩類:

**1. 36-tile 標準頭像 (32 個)**
- 索引: 6, 7, 8, 24, 25, 26, 29, 35, 38, 40, 41, 43, 44, 45, 46, 47, 49, 51, 58, 59, 61, 66, 68, 69, 70, 72, 74, 75, 76, 77, 79, 80
- 使用標準 2×2 metatile 排列 (STANDARD_LAYOUT):
```
[ 1  2][ 5  6][ 9 10]
[ 3  4][ 7  8][11 12]
[13 14][17 18][21 22]
[15 16][19 20][23 24]
[25 26][29 30][33 34]
[27 28][31 32][35 36]
```

**2. <36-tile 頭像 (49 個)**
- tile 數量: 28-35 (重複利用 tile 以節省空間)
- 使用排列表指定各位置的 tile 編號

### 排列表

**位置**: `0x1B0D4` (81 entries × 36 bytes = 2,916 bytes)

每筆排列是 36 bytes，對應 6×6 的 tile 位置。
- 值為 PPU tile index (0x64-0x87)
- 轉換為 ROM tile 編號: `rom_tile = ppu_value - 0x63`

### 頭像→排列映射 (已解決)

**公式**: `arrangement_index = portrait_index` (1:1 對應)

排列表正好 81 個條目，與頭像數量完全相同。
36-tile 標準頭像使用 STANDARD_LAYOUT，其他頭像直接用索引查找排列表。

### 驗證範例

| 武將 | 頭像索引 | 排列索引 |
|------|----------|----------|
| 劉備 | 0 | 0 |
| 諸葛亮 | 1 | 1 |
| 關羽 | 2 | 2 |
| 曹操 | 4 | 4 |
| 孫堅 | 20 | 20 |
| 袁紹 | 44 | STD |

### NES Tile 格式
- 每個 tile: 8×8 pixels, 16 bytes
- 2 bitplanes, 每個 8 bytes
- 像素值 = plane0_bit + (plane1_bit << 1)

### 色盤
```
Index 0: (0, 0, 0)         黑色
Index 1: (247, 216, 165)   淺膚色
Index 2: (234, 158, 34)    深膚色
Index 3: (255, 255, 255)   白色
```

### 匯出工具
- **portrait_export.py**: 匯出所有 81 個頭像
- 輸出: `kanji_output/portraits/portrait_XX.png`
- 總覽: `kanji_output/portrait_atlas.png`

---

## 擴展頭像系統 (P81+)

### 概要

標準頭像 (P00-P80) 有專屬的指標表與排列表，擴展頭像 (P81+) 使用「多組共用基底 + 可替換組件」的系統。

| 項目 | 標準頭像 | 擴展頭像 |
|------|----------|----------|
| 索引範圍 | 0-80 (81 個) | 81-254 (174 個) |
| 指標表 | 0x1BC38 | 未找到 (可能由程式碼計算) |
| 排列表 | 0x1B0D4 | 0x1ED14 (20 條) |
| Tile 資料 | Banks 4-6 | Bank 7 (多個基底位址) |
| 結構 | 完整獨立頭像 | 多組共用基底 + 可變臉部組件 |

### 多組共用基底系統

擴展頭像**不是**單一基底，而是存在**多組共用基底**：

```
Group A (基底 0x1D694):
  ├─ P081 周泰: 基底 + 變體 A1 (眼171/臉234/嘴336)
  ├─ P082 孫翊: 基底 + 變體 A2 (眼174/臉237/嘴348)
  └─ 其他成員...

Group B (基底 0x1C194):
  ├─ P083 孫瑜: 基底 + 變體 B1
  ├─ P084, P085...: 基底 + 變體 Bx
  └─ ...

Group C, D, E... (其他基底):
  └─ 各自的成員和變體
```

**關鍵特性：**
1. 同組內的頭像共用相同的框架 tiles (頭盔、邊框)
2. 每組有自己專屬的眼睛/鼻子/嘴巴變體 tiles
3. 變體規則在組內一致，但不同組有不同的變體 tile 位置

### 已確認的共用基底

| Group | 基底位址 | 相對 Group A | 已知成員 | 備註 |
|-------|----------|--------------|----------|------|
| A | 0x1D694 | 0 tiles | P081 周泰, P082 孫翊, P084 孫桓, P182 糜芳 | 標準框架 |
| B | 0x1C194 | +336 tiles | P083 孫瑜, P185 傅士仁, P186 周倉 | 標準框架 |
| C | 0x1C914 | +216 tiles | P131 法正, P165 張昭, P166 張紘, P204 韓玄, P211 鞏志 | 多種框架 |
| D | 0x1DB14 | -72 tiles | P195 徐盛, ... | 標準框架 |
| E | 0x1D394 | +48 tiles | P168 虞翻, ... | 不同框架 (Row 4-5) |

**重要發現: Group C 內有多種框架 tile 組**

Group C 內存在至少兩種不同的框架 tile 組:

| 框架類型 | Tile 範圍 | 特徵 | 成員 |
|----------|-----------|------|------|
| 標準型 | 0-23 | 2×2 metatile 模式 | P131 法正, P165 張昭, P166 張紘 |
| 左邊緣重複型 | 48-67 | Row 0-5 的 C0 使用 48 重複 | P204 韓玄, P211 鞏志 |

**關鍵發現：Group B 的基底比 Group A 早 336 tiles (0x1500 bytes)**

ROM 空間佈局（以 Group B 基底 0x1C194 為參考）:
```
0x1C194: Group B 基底 (tile 0)
         ├─ tiles 0-23: Group B 共用框架
         ├─ ...
         ├─ tiles 462-464: P083 眼睛
         ├─ tiles 519-521: P083 臉部
         ├─ tiles 588-593: P083 嘴巴
         │
0x1D694: Group A 基底 (= Group B tile 336)
         ├─ tiles 336-359: Group A 共用框架 (即 Group A 的 0-23)
         ├─ tiles 507-509: P081 眼睛 (即 Group A 的 171-173)
         ├─ tiles 570-572: P081 臉部 (即 Group A 的 234-236)
         ├─ tiles 672-677: P081 嘴巴 (即 Group A 的 336-341)
         └─ ...
```

### Group A 詳細結構 (已驗證)

#### 組件式 Layout

```
6×6 格子 Layout:
     C0  C1  C2  C3  C4  C5
    ┌───┬───┬───┬───┬───┬───┐
 R0 │ 0 │ 1 │ 4 │ 5 │ 8 │ 9 │ ← 共用 (頭盔)
    ├───┼───┼───┼───┼───┼───┤
 R1 │ 2 │ 3 │ 6 │ 7 │10 │11 │ ← 共用 (頭盔)
    ├───┼───┼───┼───┼───┼───┤
 R2 │12 │ ? │ ? │ ? │14 │15 │ ← 眼睛區 (C1-C3 可替換)
    ├───┼───┼───┼───┼───┼───┤
 R3 │13 │ ? │ ? │ ? │16 │17 │ ← 臉部區 (C1-C3 可替換)
    ├───┼───┼───┼───┼───┼───┤
 R4 │18 │ ? │ ? │ ? │20 │21 │ ← 嘴巴上 (C1-C3 可替換)
    ├───┼───┼───┼───┼───┼───┤
 R5 │19 │ ? │ ? │ ? │22 │23 │ ← 嘴巴下 (C1-C3 可替換)
    └───┴───┴───┴───┴───┴───┘
```

#### 已驗證的 Layout

**P081 周泰:**
```python
[  0,   1,   4,   5,   8,   9],
[  2,   3,   6,   7,  10,  11],
[ 12, 171, 172, 173,  14,  15],  # 眼睛: 171-173
[ 13, 234, 235, 236,  16,  17],  # 臉部: 234-236
[ 18, 336, 337, 340,  20,  21],  # 嘴巴上: 336,337,340
[ 19, 338, 339, 341,  22,  23],  # 嘴巴下: 338,339,341
```

**P082 孫翊:**
```python
[  0,   1,   4,   5,   8,   9],
[  2,   3,   6,   7,  10,  11],
[ 12, 174, 175, 176,  14,  15],  # 眼睛: +3
[ 13, 237, 238, 239,  16,  17],  # 臉部: +3
[ 18, 348, 349, 352,  20,  21],  # 嘴巴上: +12
[ 19, 350, 351, 353,  22,  23],  # 嘴巴下: +12
```

#### Group A 變體計算規則

在 Group A 內，相鄰頭像的變體 offset：
- **眼睛**: +3 tiles (171 → 174)
- **臉部**: +3 tiles (234 → 237)
- **嘴巴**: +12 tiles (336 → 348)

```python
# Group A 內的變體計算 (相對於 group 內的 index)
group_index = portrait_index - group_first_portrait  # P081 為 0, P082 為 1

eye_base = 171 + group_index * 3
face_base = 234 + group_index * 3
mouth_base = 336 + group_index * 12
```

#### 嘴巴 Tile 排列

嘴巴使用 6 個 tiles 排成 2×3，排列方式特殊：

```
Col 1  Col 2  Col 3
+0     +1     +4    (Row 4)
+2     +3     +5    (Row 5)
```

### Group B 詳細結構 (已驗證)

#### 基底位址
- **0x1C194** (在 Group A 之前 336 tiles)

#### 已驗證的 Layout

**P083 孫瑜:**
```python
[  0,   1,   4,   5,   8,   9],
[  2,   3,   6,   7,  10,  11],
[ 12, 462, 463, 464,  14,  15],  # 眼睛: 462-464
[ 13, 519, 520, 521,  16,  17],  # 臉部: 519-521
[ 18, 588, 589, 592,  20,  21],  # 嘴巴上
[ 19, 590, 591, 593,  22,  23],  # 嘴巴下
```

#### Group A vs Group B 比較

| 區域 | P081 (Group A) | P083 (Group B) | 備註 |
|------|----------------|----------------|------|
| 基底 | 0x1D694 | 0x1C194 | 相差 336 tiles |
| 眼睛起始 | 171 | 462 | |
| 臉部起始 | 234 | 519 | |
| 嘴巴起始 | 336 | 588 | |
| 框架 tiles | 0-23 | 0-23 | 相同模式，不同資料 |

#### 統一 ROM 視角 (以 0x1C194 為 tile 0)

| 區域 | P083 tiles | P081 tiles (轉換後) | 差距 |
|------|------------|---------------------|------|
| 眼睛 | 462-464 | 507-509 | +45 |
| 臉部 | 519-521 | 570-572 | +51 |
| 嘴巴 | 588-593 | 672-677 | +84 |

**觀察**: P083 (Group B) 的變體 tiles 在 ROM 中位於 P081 (Group A) 變體 tiles 之前

#### 區域間距分析

| Group | 眼睛→臉部 | 臉部→嘴巴 |
|-------|----------|----------|
| Group A (P081) | 63 tiles | 102 tiles |
| Group B (P083) | 57 tiles | 69 tiles |

**結論**: 不同 Group 的變體 tile 間距不同，無法用單一公式計算所有擴展頭像

### 擴展排列表

**位置**: `0x1ED14`
**結構**: 20 條記錄 × 36 bytes
**編碼**: 固定 tiles 使用 `value - 0x64`，變體位置標記為 `0x00`

### 變體計算公式 (已驗證 - 修正版)

**關鍵發現: Group A 與 Group B 共用同一組變體 tiles！**

ROM 空間佈局:
```
0x1C194: Group B 基底 (共用框架 tiles 0-23)
         ...
0x1D694: Group A 基底 (共用框架 tiles 0-23)
         ...
0x1DE14: 變體 tiles 開始 (兩個 Group 共用)
         = Group A tile 120 = Group B tile 456
```

**變體公式:**
```
eye_tile  = 120 + eye_idx × 3   (20 組, tiles 120-179)
face_tile = 180 + face_idx × 3  (20 組, tiles 180-239)
mouth_tile = 240 + mouth_idx × 6 (20 組, tiles 240-359)
```

注意: 以上 tile 編號相對於各自的 Group 基底
- Group A: 直接使用上述編號
- Group B: 編號 + 336 (因為基底差 336 tiles)

**修正後的索引值:**
| 頭像 | Group | 框架 | eye_idx | face_idx | mouth_idx |
|------|-------|------|---------|----------|-----------|
| P081 周泰 | A | 標準 | 17 | 18 | 16 |
| P082 孫翊 | A | 標準 | 18 | 19 | 18 |
| P083 孫瑜 | B | 標準 | 2 | 1 | 2 |
| P084 孫桓 | A | 標準 | 18 | 15 | 15 |
| P131 法正 | C | 標準(0-23) | 7 | 8 | 6 |
| P165 張昭 | C | 標準(0-23) | 3 | 3 | 10 |
| P166 張紘 | C | 標準(0-23) | 4 | 4 | 11 |
| P168 虞翻 | E | 特殊 | 13 | 10 | 10 |
| P182 糜芳 | A | 72-95 | 15 | 15 | 15 |
| P185 傅士仁 | B | 標準 | 4 | 5 | 6 |
| P186 周倉 | B | 標準 | 6 | 6 | 7 |
| P195 徐盛 | D | 標準 | 16 | 19 | 18 |
| P204 韓玄 | C | 48-67 | 5 | 5 | 5 |
| P211 鞏志 | C | 48-67 | 5 | 6 | 8 |

**觀察:**
- 每種組件有 20 個變體 (0-19)
- 眼睛和臉部各佔 3 tiles，嘴巴佔 6 tiles
- 同一變體可被不同頭像共用 (P082 和 P084 共用 eye_idx=18)
- Group 只影響框架 tiles (0-23)，變體 tiles 是共用的

### Group D 詳細結構 (已驗證)

**基底位址:** 0x1DB14 (Group A 之後 72 tiles)

**P195 徐盛:**
```python
[  0,   1,   4,   5,   8,   9],
[  2,   3,   6,   7,  10,  11],
[ 12,  96,  97,  98,  14,  15],  # eye_idx=16
[ 13, 165, 166, 167,  16,  17],  # face_idx=19
[ 18, 276, 277, 280,  20,  21],  # mouth_idx=18
[ 19, 278, 279, 281,  22,  23],
```

**Group D 框架特徵:** 標準框架 (與 Group A 相同)

### Group E 詳細結構 (已驗證)

**基底位址:** 0x1D394 (Group A 之前 48 tiles)

**P168 虞翻:**
```python
[  0,   1,   4,   5,   8,   9],
[  2,   3,   6,   7,  10,  11],
[ 12, 207, 208, 209,  14,  15],  # eye_idx=13
[ 13, 258, 259, 260,  16,  17],  # face_idx=10
[ 13, 348, 349, 352,  19,  13],  # mouth_idx=10 (注意: C0=13, C4=19, C5=13)
[ 18, 350, 351, 353,  20,  21],  # (注意: C0=18)
```

**Group E 框架特徵:** Row 4-5 邊緣 tiles 略有不同

### Group A 更多範例

**P182 糜芳 (框架 72-95):**
```python
[ 72,  73,  76,  77,  80,  81],
[ 74,  75,  78,  79,  82,  83],
[ 84, 165, 166, 167,  86,  87],  # eye_idx=15
[ 85, 225, 226, 227,  88,  89],  # face_idx=15
[ 90, 330, 331, 334,  92,  93],  # mouth_idx=15
[ 91, 332, 333, 335,  94,  95],
```

**觀察:** 糜芳使用不同的框架 tile 組 (72-95)，但仍屬於 Group A

### Group C 詳細結構 (多框架型)

**基底位址:** 0x1C914

Group C 特殊之處在於包含多種框架 tile 組:

#### 框架類型 1: 標準型 (tiles 0-23)

**P131 法正:**
```python
[  0,   1,   4,   5,   8,   9],
[  2,   3,   6,   7,  10,  11],
[ 12, 357, 358, 359,  14,  15],  # eye_idx=7
[ 13, 420, 421, 422,  16,  13],  # face_idx=8
[ 13, 492, 493, 496,  18,  13],  # mouth_idx=6
[ 17, 494, 495, 497,  19,  20],
```

**P165 張昭:**
```python
[  0,   1,   4,   5,   8,   9],
[  2,   3,   6,   7,  10,  11],
[ 12, 363, 364, 365,  14,  15],  # eye_idx=3 (修正: 非 9)
[ 13, 420, 421, 422,  16,  13],  # face_idx=3 (修正: 非 8)
[ 13, 492, 493, 496,  18,  13],  # mouth_idx=10 (修正: 非 6)
[ 17, 494, 495, 497,  19,  20],
```

**P166 張紘:**
```python
[  0,   1,   4,   5,   8,   9],
[  2,   3,   6,   7,  10,  11],
[ 12, 363, 364, 365,  14,  15],  # eye_idx=4 (修正: 非 9)
[ 13, 423, 424, 425,  16,  13],  # face_idx=4 (修正: 非 9)
[ 13, 504, 505, 508,  18,  13],  # mouth_idx=11 (修正: 非 8)
[ 17, 506, 507, 509,  19,  20],
```

#### 框架類型 2: 左邊緣重複型 (tiles 48-67)

**P204 韓玄:**
```python
[ 48,  49,  51,  52,  55,  56],
[ 48,  50,  53,  54,  57,  58],
[ 48, 351, 352, 353,  59,  60],  # eye_idx=5
[ 48, 411, 412, 413,  61,  62],  # face_idx=5
[ 48, 486, 487, 490,  64,  65],  # mouth_idx=5
[ 63, 488, 489, 491,  66,  67],
```

**P211 鞏志:**
```python
[ 48,  49,  51,  52,  55,  56],
[ 48,  50,  53,  54,  57,  58],
[ 48, 351, 352, 353,  59,  60],  # eye_idx=5 (與韓玄相同!)
[ 48, 414, 415, 416,  61,  62],  # face_idx=6
[ 48, 504, 505, 508,  64,  65],  # mouth_idx=8
[ 63, 506, 507, 509,  66,  67],
```

**觀察:**
- 韓玄與鞏志共用相同的框架 tiles (48-67)
- 共用相同的眼睛變體 (eye_idx=5, tiles 351-353)
- 臉部和嘴巴使用不同變體

### 變體索引表 (位置待確認)

**可能位置:** `0x1EFE8` 附近

**結構推測:** 每個擴展頭像需要以下資料:
- Group ID (1 byte): 0=Group A, 1=Group B, ...
- eye_idx (1 byte): 0-19
- face_idx (1 byte): 0-19
- mouth_idx (1 byte): 0-19

**搜尋結果:**
- 0x1EFE8 區域包含 0-4 範圍的小值
- P083 的 (2, 1, 2) 模式在此區域多次出現
- 但 P081 (17, 18, 16) 和 P082 (18, 19, 18) 未找到連續序列

**可能原因:**
1. 索引值經過某種編碼/壓縮
2. 表格順序與 portrait_index 不一致
3. 使用間接索引 (先查表得到 entry index)
4. 資料分散存放 (eye/face/mouth 各自獨立的表)

### 待解決問題

1. **變體索引表確切位置**: 0x1EFE8 區域有相關資料，但結構尚未完全解碼
2. **portrait_index → table entry 映射**: 如何從 portrait_index 找到正確的索引?
3. **Group 映射表位置**: 如何判斷頭像屬於哪個 Group?
4. **框架類型映射**: 同一 Group 內有多種框架類型 (如 Group C 有 0-23 與 48-67)，如何判斷?
5. **完整的 174 個擴展頭像解碼**: 需要更多已知 layout 來反推表格結構

### 已解決問題

1. ~~其他 Group 基底~~: 已確認 Groups A-E 的基底位址
2. ~~portrait_matcher 工具~~: 可自動從遊戲截圖識別 layout 和變體索引

### 調試進度 (進行中)

**目標**: 找出 portrait_index 如何轉換為頭像 tile 資料的程式邏輯

**已嘗試的方法**:
1. ROM 搜尋 `SBC #$51` / `CMP #$51` - 找到一些位置但無法確認是頭像相關
2. 搜尋引用 $BC38 (標準指標表) 的程式碼 - 未在 Bank 7 找到
3. Mesen Lua 腳本監視 PRG ROM 讀取 - 腳本已載入但顯示頭像時無輸出

**可能原因**:
- 頭像資料可能在遊戲初始化時已載入 RAM，之後從 RAM 讀取
- 需要監視 CPU Memory (RAM) 而非 PRG ROM
- 或需要監視 PPU 寫入來追蹤 tile 繪製

**下次待辦**:
1. 嘗試監視 CPU RAM ($0000-$07FF) 的寫入，找出頭像資料載入時機
2. 或監視 PPU Memory ($0000-$1FFF) 的寫入，追蹤 tile pattern 載入
3. 嘗試在遊戲啟動時就開始監視，而非等到顯示頭像
4. 考慮使用 Mesen 的 Trace Logger 功能記錄完整執行流程

### 工具

**tools/portrait_matcher.py** - 自動匹配截圖與 ROM tiles

```bash
# 使用方法
python tools/portrait_matcher.py <screenshot.png> <group> [--portrait-id PXXX]

# 範例
python tools/portrait_matcher.py mob_portrait/screenshot/法正.png C --portrait-id P131
```

支援的 Groups:
- A (0x1D694), B (0x1C194), C (0x1C914), D (0x1DB14)
- E (0x1D394), F (0x1D994), G (0x1DC94), H (0x102A4)

### 輸出檔案

**Group A (0x1D694):**
- `mob_portrait/tiles/layout_P81_P82.txt`: P081, P082 的完整 layout
- `mob_portrait/tiles/zhou_tai_portrait.png`: P081 周泰頭像
- `mob_portrait/tiles/sun_yi_portrait_corrected.png`: P082 孫翊頭像

**Group B (0x1C194):**
- `mob_portrait/tiles_P083/layout_P083.txt`: P083 layout 與分析
- `mob_portrait/tiles_P083/sun_yu_portrait.png`: P083 孫瑜頭像
- `mob_portrait/tiles_P083/tile_000.png ~ tile_799.png`: 800 個 tiles
- `mob_portrait/tiles_P083/_sheet_0_799.png`: 合併圖表

**截圖:**
- `mob_portrait/screenshot/`: 遊戲截圖 (用於 portrait_matcher.py)

**探索用:**
- `mob_portrait/tiles_negative/`: 負向 tile 探索 (用於尋找其他 Group)

---

## 檔案清單

| 檔案 | 說明 |
|------|------|
| `sangokushi_extract_v2.py` | 武將資料解析主程式 (含頭像/排列索引) |
| `kanji_export.py` | 漢字字型匯出工具 |
| `portrait_export.py` | 頭像匯出工具 (48×48 PNG) |
| `Sangokushi (Japan)_characters_v2.csv` | 匯出的 CSV (256 筆武將) |
| `Sangokushi (Japan)_characters_v2.xlsx` | 匯出的 Excel (含格式, 需 openpyxl) |
| `光榮三國志系列武將登場統計 - 能力表.csv` | 外部參考資料, 用於比對武將姓名 |
| `CLAUDE.md` | Claude Code 專案指示 |
| `MEMORY.md` | 本檔案 — 研究記錄 |
| `docs/DATA_FORMAT.md` | 武將資料表格式 (含頭像映射) |
| `docs/ROM_STRUCTURE.md` | ROM 檔案結構 (含頭像系統) |
| `docs/KANJI_TILES_ANALYSIS.md` | 漢字 tile 映射分析 |
| `docs/KANJI_DIFF.md` | ROM 漢字與外部姓名差異對照 |

---

## 下一步待辦

1. ~~**頭像匯出**: 追蹤遊戲 6502 程式碼中頭像顯示流程, 建立 portrait index → tile data 的完整映射, 匯出 48×48 頭像圖片~~ ✓ 已完成
2. **城市名稱表**: 尋找 ROM 中城市 ID → 城市名稱的對照表
3. ~~**武將姓名表**: 尋找 ROM 中武將姓名的存放位置~~ ✓ 已找到 (0x3A314, 半角片假名編碼)
4. **未確認欄位**: 透過遊戲測試確認 B1 (Body) 和 B5 (Luck) 的實際用途
5. ~~**完善角色對照**: 補齊更多角色的序號-姓名-假名對應~~ ✓ 已透過外部 CSV 完成 255/256 筆
6. **舞台配置資料**: 若需確認不同舞台的武將配置，可用模擬器調試功能追蹤遊戲選擇舞台時的記憶體變化
7. ~~**姓名表未知欄位**: 解析姓名記錄中 +8 到 +14 的 7 bytes 用途~~ ✓ 已確認完整結構:
   - +8/+10/+12: 漢字 tile ID (建立 238 字對照表)
   - +9/+11/+13: 漢字 Page 指示器
   - +14: 頭像索引 byte
8. ~~**頭像與武將對應**: 找出頭像索引 (0-80) 與武將索引 (0-255) 的對應關係~~ ✓ 已解決 (姓名表 byte 14)
9. ~~**頭像→排列映射**: 建立頭像索引到排列索引的映射~~ ✓ 已解決 (1:1 對應，排列表起始 0x1B0D4)
