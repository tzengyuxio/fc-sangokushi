# MEMORY.md — 三國志 NES ROM 逆向工程研究記錄

> **已完成的分析** (武將表、姓名表、標準頭像等) 已移至 `docs/COMPLETED_ANALYSIS.md`

---

## ROM 概要

| 項目 | 值 |
|------|------|
| 檔名 | `Sangokushi (Japan).nes` |
| Mapper | 1 (MMC1) |
| PRG ROM | 256 KB = 16 banks × 16 KB |
| PRG 偏移 | 0x00010 – 0x4000F |
| CHR ROM | 0 KB (CHR-RAM) |
| Bank 換算 | `file_offset = bank × 0x4000 + 0x10` |

---

## 大眾臉頭像系統 (P81-P254)

### 概要

| 項目 | 值 |
|------|------|
| 索引範圍 | 81-254 (174 個頭像) |
| 結構 | 20 Groups × 可變 variants |
| Tile 資料 | Bank 7 |
| 排列表 | 0x1ED14 (20 條 × 36 bytes) |

### 20 個 Group 位置表

| Group | ROM 基底 | Tiles | Group | ROM 基底 | Tiles |
|-------|----------|-------|-------|----------|-------|
| G00 | 0x1C014 | 24 | G10 | 0x1CF14 | 24 |
| G01 | 0x1C194 | 24 | G11 | 0x1D094 | 21 |
| G02 | 0x1C314 | 24 | G12 | 0x1D214 | 21 |
| G03 | 0x1C494 | 24 | G13 | 0x1D394 | 22 |
| G04 | 0x1C614 | 24 | G14 | 0x1D514 | 22 |
| G05 | 0x1C794 | 22 | G15 | 0x1D694 | 24 |
| G06 | 0x1C914 | 21 | G16 | 0x1D814 | 24 |
| G07 | 0x1CA94 | 20 | G17 | 0x1D994 | 24 |
| G08 | 0x1CC14 | 20 | G18 | 0x1DB14 | 24 |
| G09 | 0x1CD94 | 21 | G19 | 0x1DC94 | 24 |

### 變體組件位置

| 組件 | ROM 位置 | 結構 |
|------|----------|------|
| 眼睛 | 0x1DE14 | 20 組 × 3 tiles × 16 bytes |
| 臉部 | 0x1E1D4 | 20 組 × 3 tiles × 16 bytes |
| 嘴巴 | 0x1E594 | 20 組 × 6 tiles × 16 bytes |

### Group → Template 對應

**1:1 映射**: G00-G19 對應 T00-T19

Template 位置: `0x1ED14 + template_idx × 36`

### 已驗證索引表 (43 筆)

| 頭像 | Group | E | F | M | 頭像 | Group | E | F | M |
|------|-------|---|---|---|------|-------|---|---|---|
| P081 周泰 | G15 | 17 | 18 | 16 | P121 李傕 | G10 | 13 | 14 | 13 |
| P082 孫翊 | G15 | 18 | 19 | 18 | P122 蔡邕 | G10 | 14 | 12 | 14 |
| P083 孫瑜 | G01 | 2 | 1 | 2 | P123 郭汜 | G11 | 10 | 11 | 12 |
| P084 孫桓 | G15 | 18 | 15 | 15 | P124 張濟 | G11 | 11 | 14 | 13 |
| P092 陳琳 | G05 | 8 | 6 | 7 | P125 華雄 | G16 | 17 | 15 | 16 |
| P093 田豐 | G05 | 9 | 7 | 9 | P127 徐榮 | G11 | 13 | 10 | 10 |
| P095 沮授 | G05 | 9 | 8 | 6 | P128 胡軫 | G16 | 18 | 19 | 18 |
| P097 高覽 | G01 | 3 | 1 | 2 | P129 趙岑 | G16 | 18 | 15 | 15 |
| P099 袁譚 | G02 | 0 | 1 | 2 | P130 董旻 | G11 | 14 | 13 | 11 |
| P100 袁熙 | G02 | 2 | 1 | 2 | P131 法正 | G06 | 7 | 8 | 6 |
| P111 黃祖 | G10 | 12 | 11 | 12 | P135 鄧賢 | G06 | 8 | 6 | 7 |
| P117 張允 | G04 | 4 | 4 | 3 | P138 高沛 | G00 | 2 | 3 | 1 |
| P118 蔡和 | G04 | 3 | 4 | 3 | P146 馬鐵 | G02 | 1 | 0 | 0 |
| P119 蔡中 | G04 | 1 | 4 | 3 | P147 侯選 | G17 | 15 | 15 | 15 |
| P120 李肅 | G16 | 17 | 17 | 19 | P148 程銀 | G02 | 3 | 0 | 0 |
| P149 李堪 | G03 | 2 | 3 | 1 | P182 糜芳 | G18 | 15 | 15 | 15 |
| P150 張橫 | G17 | 15 | 16 | 17 | P185 傅士仁 | G19 | 15 | 16 | 17 |
| P165 張昭 | G06 | 9 | 8 | 6 | P186 周倉 | G17 | 19 | 17 | 19 |
| P166 張紘 | G06 | 9 | 8 | 8 | P189 闞澤 | G07 | 7 | 7 | 7 |
| P168 虞翻 | G13 | 13 | 10 | 10 | P195 徐盛 | G18 | 16 | 19 | 18 |
| P204 韓玄 | G08 | 5 | 5 | 5 | P211 鞏志 | G08 | 5 | 6 | 8 |
| P214 文聘 | G18 | 18 | 16 | 17 | | | | | |

### Group 變體統計

| Group | 樣本 | Eyes | Faces | Mouths | 親和區間 |
|-------|------|------|-------|--------|----------|
| G00 | 1 | 2 | 3 | 1 | #0-#4 |
| G01 | 2 | 2-3 | 1 | 2 | #0-#4 |
| G02 | 4 | 0-3 | 0-1 | 0-2 | #0-#4 |
| G03 | 1 | 2 | 3 | 1 | #0-#4 |
| G04 | 3 | 1-4 | 4 | 3 | #0-#4 |
| G05 | 3 | 8-9 | 6-8 | 6-9 | #5-#9 |
| G06 | 4 | 7-9 | 6-8 | 6-8 | #5-#9 |
| G07 | 1 | 7 | 7 | 7 | #5-#9 |
| G08 | 2 | 5 | 5-6 | 5-8 | #5-#9 |
| G09 | 0 | - | - | - | #10-#14 |
| G10 | 3 | 12-14 | 11-14 | 12-14 | #10-#14 |
| G11 | 4 | 10-14 | 10-14 | 10-13 | #10-#14 |
| G12 | 0 | - | - | - | #10-#14 |
| G13 | 1 | 13 | 10 | 10 | #10-#14 |
| G14 | 0 | - | - | - | #10-#14 |
| G15 | 3 | 17-18 | 15-19 | 15-18 | #15-#19 |
| G16 | 4 | 17-18 | 15-19 | 15-19 | #15-#19 |
| G17 | 3 | 15-19 | 15-17 | 15-19 | #15-#19 |
| G18 | 3 | 15-18 | 15-19 | 15-18 | #15-#19 |
| G19 | 1 | 15 | 16 | 17 | #15-#19 |

**親和區間總結:**
- G00-G04 → 變體 #0-#4
- G05-G08 → 變體 #5-#9
- G09-G14 → 變體 #10-#14
- G15-G19 → 變體 #15-#19

### 變體索引表

| 表格 | ROM 位置 | 長度 | 值範圍 |
|------|----------|------|--------|
| T1 (眼睛?) | 0x1EFE4 | 174 | 0-4 |
| T2 (臉部?) | 0x1F092 | 174 | 0-4 |
| T3 (嘴巴?) | 0x1F140 | 174 | 0-4 |

**計算公式 (待驗證):**
```
variant_idx = T[portrait_index - 81] + (group_zone × 5)
```

---

## 待解決問題

1. **portrait_id → Group 映射**: 如何從 portrait_id (81-254) 決定使用哪個 Group?
2. **變體索引表解讀**: T1/T2/T3 三個表格的值 (0-4) 如何對應到實際的 eye/face/mouth index?
3. **G09/G12/G14 無樣本**: 這三個 Group 目前沒有已知武將使用

---

## 下一步待辦

- [ ] 解析 portrait_id → Group 的映射機制
- [ ] 驗證變體索引表計算公式
- [ ] 收集 G09/G12/G14 的武將樣本
- [ ] 城市名稱表位置
- [ ] 未確認欄位 (Body/Luck) 遊戲驗證

---

## 工具

| 工具 | 說明 |
|------|------|
| `mob_portrait/variant_explorer/` | 大眾臉頭像探索器 |
| `mob_portrait/variant_explorer/extract_components.py` | 資產提取腳本 |
