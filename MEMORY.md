# MEMORY.md — 三國志 NES ROM 逆向工程研究記錄

## ROM 概要

| 項目 | 值 |
|------|------|
| 檔名 | `Sangokushi__Japan_.nes` |
| Mapper | 1 (MMC1) |
| PRG ROM | 256 KB = 16 banks × 16 KB |
| PRG 偏移 | 0x00010 – 0x4000F (扣除 16-byte iNES header) |
| CHR ROM | 0 KB (CHR-RAM, tile 資料存於 PRG ROM) |
| Bank 換算 | 檔案偏移 = bank × 0x4000 + 0x10 |

---

## 武將資料表 (已完成解析)

### 位置
- 所在 Bank: 14 (檔案偏移 0x38010–0x3C00F)
- 表頭: 0x38010–0x38013 = `4C 00 00 00` (0x4C = 76)
- 資料起始: 0x38014
- 記錄數: 256 筆
- 資料結束: 0x39113

### 記錄結構 (17 bytes/筆)

```
Offset  Size  欄位             說明
+0      1     Age (signed)     年齡, signed byte. 正=遊戲開始時年齡, 負=尚未出生
+1      1     Body             體力 (15–100), 推測為壽命/健康度
+2      1     Intelligence     智力 (15–100) ✓已驗證
+3      1     Military         武力 (15–100) ✓已驗證
+4      1     Charisma         魅力 (15–100) ✓已驗證
+5      1     Luck             運氣? (15–100), 用途未確認
+6      1     Loyalty          忠誠 (12–100), 君主固定100
+7      1     Status+Navy      複合 bitfield:
                                 bit0 = 水軍旗標 (1=水軍) ✓已驗證
                                 bit1 = 統領旗標 (1=君主或軍師)
                                 組合: 0=一般非水軍, 1=一般水軍,
                                       2=統領非水軍(軍師), 3=統領水軍(君主)
+8,+9   2     Troops (LE16)    兵士數, little-endian ✓已驗證
+10     1     City             城市 ID (0–55), 0=未配置
+11     1     Faction          勢力 ID (0–14), 0=無勢力
+12–16  5     Separator        固定 0A 0A 0A 00 00
```

### 統計
- 水軍 151 人 / 非水軍 105 人
- 統領 15 人 (12 君主 + 3 軍師)
- 負年齡 (未出生) 12 人

### 勢力對照 (推斷)
| Faction | 勢力 | 起始記錄 |
|---------|------|----------|
| 1 | 曹操 | #0, #1 |
| 2 | 孫堅 | #2 |
| 3 | 劉備 | #3 |
| 4 | 袁紹 | #4 |
| 5 | 袁術 | #5 |
| 6 | 劉表 | #6 |
| 7 | 董卓 | #7 |
| 8 | 劉焉 | #8 |
| 9 | 馬騰 | #9 |
| 10 | 公孫瓚 | #10 |
| 11 | 陶謙 | #141 |
| 12–14 | 其他 | — |

### 未確認欄位
- **B1 (Body)**: 範圍 15–100, 推測壽命或健康度, 需要更多遊戲驗證
- **B5 (Luck)**: 範圍 15–100, 可能是運氣/義理, 需要更多遊戲驗證
- **B0 (Age)**: 確認為年齡, 但表頭的 0x4C=76 意義不明 (可能為初始可用武將數?)

### 分隔符分析 (+12–16, 5 bytes)

**觀察結果:**
- 所有 256 筆武將記錄的分隔符都是 `0A 0A 0A 00 00`，完全相同
- ROM 中只有一個 17-byte 記錄表結構（武將資料表本身）
- 未發現其他平行的舞台配置表

**假設檢驗: 5 bytes 對應 5 個遊戲舞台?**
- 遊戲有 5 個舞台，武將在不同舞台可能有不同狀態（未登場/已登場/死亡）
- 若此假設成立，每個武將應該有不同的值，但實際上所有記錄都相同
- **結論: 此假設不成立**

**可能的解釋:**
1. 這 5 bytes 確實只是結構標記/填充，用於記錄對齊或結束標記
2. 舞台配置資料存在 RAM 而非 ROM（遊戲啟動時根據選擇的舞台動態設定）
3. 舞台差異資料使用不同結構儲存在 ROM 其他位置（如差分資料）

**補充統計:**
- 城市=0 且 勢力=0 的武將: 75 人（可能為在野或尚未登場）
- 這些武將的登場狀態可能由遊戲程式根據舞台動態決定

---

## 武將姓名對照 (已完成)

透過外部資料「光榮三國志系列武將登場統計 - 能力表.csv」的 S01 欄位，以五項能力值 (體力/智力/武力/魅力/運勢) 進行比對，成功匹配 **255/256** 筆武將姓名。

匹配方式: ROM 記錄的 (Body, Intelligence, Military, Charisma, Luck) 與外部 CSV 的 S01 能力值完全一致。

| 項目 | 數量 |
|------|------|
| 總記錄數 | 256 |
| 成功匹配 | 255 |
| 未匹配 | 1 (Index 0, 能力值 88/90/91/97/90, 可能為自訂君主) |

詳細對照請參考匯出的 CSV/XLSX 檔案。

---

## 武將姓名表 (已完成解析)

### 位置
- 所在 Bank: 14 (與武將資料表同 Bank)
- 表頭: 0x3A310–0x3A313 = `4C 00 00 00` (與武將資料表相同)
- 資料起始: 0x3A314
- 記錄數: 257 筆 (包含索引 0 的新君主模板)
- 資料結束: 約 0x3B824

### 記錄結構 (15 bytes/筆)

```
Offset  Size  欄位             說明
+0      8     Name             假名 (半角片假名, Shift-JIS 0xA6–0xDF)
                               以 0x00 結尾，不足 8 bytes 則填充 0x00
+8      1     Kanji1 TileID    第一個漢字的 tile ID ✓已驗證
+9      1     Unknown1         用途未知
+10     1     Kanji2 TileID    第二個漢字的 tile ID ✓已驗證
+11     1     Unknown2         用途未知
+12     1     Kanji3 TileID    第三個漢字的 tile ID ✓已驗證 (複姓用)
+13-14  2     Unknown3         用途未知 (可能是顯示相關)
```

**漢字 tile ID 說明:**
- 每個武將姓名最多 3 個漢字 (位於 +8, +10, +12)
- Tile ID 對應遊戲內 CHR-RAM 中的漢字圖形
- 共發現 238 個不同的漢字 tile ID
- 詳細對照表見下方「漢字 Tile 對照表」章節

### 編碼說明

假名使用 **Shift-JIS 半角片假名** 編碼 (0xA6–0xDF):
- 清音: ｱ(0xB1) ｲ(0xB2) ｳ(0xB3) ｴ(0xB4) ｵ(0xB5) ...
- 濁音: 基本假名 + ﾞ(0xDE), 如 ｶﾞ = 0xB6 0xDE
- 半濁音: 基本假名 + ﾟ(0xDF), 如 ﾊﾟ = 0xCA 0xDF
- 拗音: 小字 ｬ(0xAC) ｭ(0xAD) ｮ(0xAE) ｯ(0xAF)

### 比對結果

| 索引 | ROM 假名 | 對應漢字 |
|------|----------|----------|
| 0 | ｿｳｿｳ | (新君主模板?) |
| 1 | ｿｳｿｳ | 曹操 |
| 2 | ｿﾝｹﾝ | 孫堅 |
| 3 | ﾘｭｳﾋﾞ | 劉備 |
| 4 | ｴﾝｼｮｳ | 袁紹 |
| 5 | ｴﾝｼﾞｭﾂ | 袁術 |
| 6 | ﾘｭｳﾋｮｳ | 劉表 |
| 7 | ﾄｳﾀｸ | 董卓 |
| 8 | ﾘｭｳｴﾝ | 劉焉 |
| 9 | ﾊﾞﾄｳ | 馬騰 |
| 10 | ｺｳｿﾝｻﾝ | 公孫瓚 |
| ... | ... | ... |

與外部 CSV 比對成功率: **249/257** (96.9%)

---

## 假名字體 tile (已定位)

### 位置
- 所在 Bank: 8 (檔案偏移 0x20010–0x24010)
- 字體起始: 0x22CA0
- Tile 大小: 8×8 pixels, 16 bytes/tile

### 字體特徵
- 每個假名 tile 包含陰影效果 (上半部分淡色, 下半部分深色)
- 可能用於遊戲中的人名顯示

### 五十音對照表 (推測)
從 0x22CA0 開始，tile 按五十音順序排列:
```
Tile  0 = ア   Tile 10 = サ   Tile 20 = ナ   Tile 30 = マ   Tile 40 = ラ
Tile  1 = イ   Tile 11 = シ   Tile 21 = ニ   Tile 31 = ミ   Tile 41 = リ
Tile  2 = ウ   Tile 12 = ス   Tile 22 = ヌ   Tile 32 = ム   Tile 42 = ル
Tile  3 = エ   Tile 13 = セ   Tile 23 = ネ   Tile 33 = メ   Tile 43 = レ
Tile  4 = オ   Tile 14 = ソ   Tile 24 = ノ   Tile 34 = モ   Tile 44 = ロ
Tile  5 = カ   Tile 15 = タ   Tile 25 = ハ   Tile 35 = ヤ   Tile 45 = ワ
Tile  6 = キ   Tile 16 = チ   Tile 26 = ヒ   Tile 36 = ユ   Tile 46 = ヲ
Tile  7 = ク   Tile 17 = ツ   Tile 27 = フ   Tile 37 = ヨ   Tile 47 = ン
Tile  8 = ケ   Tile 18 = テ   Tile 28 = ヘ   Tile 38 = ...
Tile  9 = コ   Tile 19 = ト   Tile 29 = ホ   Tile 39 = ...
```

濁點 (゛) 和半濁點 (゜) 可能在 tile 45 之後。

---

## 漢字 Tile 對照表 (已完成解析)

### 圖形儲存位置 (已確認)

透過 Mesen debugger 追蹤，確認漢字 tile 圖形的 ROM 位置：

```
PRG_ROM_offset = 0x205E4 + (tile_id + 0x30) × 16
File_offset = PRG_ROM_offset + 0x10
```

- **基址 (PRG ROM)**: `0x205E4`
- **基址 (檔案)**: `0x205F4`
- **所在 Bank**: 8 (0x20010–0x2400F)
- **每個漢字**: 64 bytes (4 個 8×8 tiles)
- **PPU 偏移**: `+0x30` (tile_id + 0x30 = PPU tile index)

### 統計
- Page 0: **241** 個不同的漢字 tile ID (0x01-0xFF)
- Page 1: **67** 個擴展漢字 (0x01-0x42, 需 +9/+11/+13 flag)
- 總計: **308** 個漢字

### 部分對照表 (依 tile ID 排序)

```
ID   漢字    ID   漢字    ID   漢字    ID   漢字    ID   漢字
0x01 翊     0x10 王     0x24 關     0x3E 堅     0x55 司
0x02 苞     0x11 黃     0x25 韓     0x3F 憲     0x5A 慈
0x03 允     0x12 樊     0x26 玩     0x40 權     0x6E 諸
0x04 紘     0x13 稠     0x27 雍     0x41 謙     0x6F 徐
0x05 羽     0x14 軫     0x28 曠     0x43 嚴     0x8D 操
0x06 熙     0x15 夏     0x29 翔     0x44 玄     0x8E 曹
0x07 叡     0x16 華     0x2A 紀     0x45 胡     0x91 孫
0x08 蔡     0x17 旻     0x2B 儀     0x46 顧     0x92 遜
0x09 永     0x18 陶     0x2C 宜     0x47 吳     0x9F 張
0x0A 琦     0x19 璋     0x2D 休     0x4A 公     0xA0 超
0x0B 琮     0x1A 沛     0x2E 宮     0x4B 孔     0xA1 陳
0x0C 越     0x1B 郭     0x2F 玠     0x4C 洪     0xAB 董
0x0D 延     0x1C 懿     0x30 許     0x4D 晃     0xB6 馬
0x0E 應     0x1D 龐     0x31 顗     0x50 高     0xBD 備
0x0F 汜     0x1E 桓     0x32 興     0x51 綱     0xE3 劉
0x10 王     0x1F 于     0x33 欽     0x52 濟     0xE5 亮
...
```

### 驗證範例

| 索引 | 假名 | Tile IDs (hex) | 解碼漢字 | 外部比對 |
|------|------|----------------|----------|----------|
| 1 | ｿｳｿｳ | 8E 8D | 曹操 | ✓ |
| 2 | ｿﾝｹﾝ | 91 3E | 孫堅 | ✓ |
| 3 | ﾘｭｳﾋﾞ | E3 BD | 劉備 | ✓ |
| 174 | ｼｮｶﾂﾘｮｳ | 6E E5 | 諸亮 | ✓ (諸葛亮，葛字可能省略) |

完整對照表定義於 `sangokushi_extract_v2.py` 的 `KANJI_TILE_MAP` 常數中。

---

## 頭像系統 (部分分析, 未完成)

### 已知事項
- 頭像為 6×6 tiles = 48×48 pixels = 36 tiles × 16 bytes = 576 bytes/頭像
- Tile 資料散佈於 PRG ROM banks 3–8
- 非連續存放, 透過拼接表 (nametable mapping) 組合
- Age 欄位 (原先誤判為 Portrait Index) 有 60 種不同值

### 關鍵程式碼位置
- Bank 切換: $C546 (檔案偏移 0x3C556)
- Tile 複製: $C280 (檔案偏移 0x3C290)
- 變數 $0052 存放 bank 編號
- 拼接表候選: Bank 6 (0x1B0FE–0x1B2CE), 16-byte blocks, 值域 0x64–0x87

### 未解決問題
- 拼接表資料顯示 4×4 結構, 但頭像實際為 6×6, 存在矛盾
- 需要追蹤遊戲顯示頭像的完整流程才能確認 tile 拼接方式
- 頭像索引與 tile 資料的對應關係尚未建立

---

## 檔案清單

| 檔案 | 說明 |
|------|------|
| `sangokushi_extract_v2.py` | 武將資料解析主程式 |
| `Sangokushi (Japan)_characters_v2.csv` | 匯出的 CSV |
| `Sangokushi (Japan)_characters_v2.xlsx` | 匯出的 Excel (含格式, 需 openpyxl) |
| `光榮三國志系列武將登場統計 - 能力表.csv` | 外部參考資料, 用於比對武將姓名 |
| `CLAUDE.md` | Claude Code 專案指示 |
| `MEMORY.md` | 本檔案 — 研究記錄 |
| `docs/DATA_FORMAT.md` | 資料格式詳細文件 |

---

## 下一步待辦

1. **頭像匯出**: 追蹤遊戲 6502 程式碼中頭像顯示流程, 建立 portrait index → tile data 的完整映射, 匯出 48×48 頭像圖片
2. **城市名稱表**: 尋找 ROM 中城市 ID → 城市名稱的對照表
3. ~~**武將姓名表**: 尋找 ROM 中武將姓名的存放位置~~ ✓ 已找到 (0x3A314, 半角片假名編碼)
4. **未確認欄位**: 透過遊戲測試確認 B1 (Body) 和 B5 (Luck) 的實際用途
5. ~~**完善角色對照**: 補齊更多角色的序號-姓名-假名對應~~ ✓ 已透過外部 CSV 完成 255/256 筆
6. **舞台配置資料**: 若需確認不同舞台的武將配置，可用模擬器調試功能追蹤遊戲選擇舞台時的記憶體變化
7. ~~**姓名表未知欄位**: 解析姓名記錄中 +8 到 +14 的 7 bytes 用途~~ ✓ 已確認 +8/+10/+12 為漢字 tile ID，建立 238 字對照表
