# MEMORY.md — 三國志 NES ROM 逆向工程研究記錄

> **已完成的分析** (武將表、姓名表、標準頭像等) 已移至 `docs/COMPLETED_ANALYSIS.md`

---

## ROM 概要

| 項目 | 值 |
|------|------|
| 檔名 | `Sangokushi (Japan).nes` |
| Mapper | 1 (MMC1) |
| PRG ROM | 256 KB = 16 banks × 16 KB |
| PRG 偏移 | 0x00010 – 0x4000F |
| CHR ROM | 0 KB (CHR-RAM) |
| Bank 換算 | `file_offset = bank × 0x4000 + 0x10` |

---

## 大眾臉頭像系統 (P81-P254)

### 概要

| 項目 | 值 |
|------|------|
| 索引範圍 | 81-254 (174 個頭像) |
| 結構 | 20 Heads × 可變 variants |
| Tile 資料 | Bank 7 |
| 排列表 | 0x1ED14 (20 條 × 36 bytes) |

### 20 個 Head 位置表

所有 Head 都佔用 24 tiles 的空間 (384 bytes)，部分 Head 使用重複 tile 填充。

| Head | ROM 基底 | Head | ROM 基底 |
|------|----------|------|----------|
| H00 | 0x1C014 | H10 | 0x1CF14 |
| H01 | 0x1C194 | H11 | 0x1D094 |
| H02 | 0x1C314 | H12 | 0x1D214 |
| H03 | 0x1C494 | H13 | 0x1D394 |
| H04 | 0x1C614 | H14 | 0x1D514 |
| H05 | 0x1C794 | H15 | 0x1D694 |
| H06 | 0x1C914 | H16 | 0x1D814 |
| H07 | 0x1CA94 | H17 | 0x1D994 |
| H08 | 0x1CC14 | H18 | 0x1DB14 |
| H09 | 0x1CD94 | H19 | 0x1DC94 |

### 變體組件位置

| 組件 | ROM 位置 | 結構 |
|------|----------|------|
| 眼睛 (Eye) | 0x1DE14 | 20 組 × 3 tiles × 16 bytes |
| 鼻子 (Nose) | 0x1E1D4 | 20 組 × 3 tiles × 16 bytes |
| 嘴巴 (Mouth) | 0x1E594 | 20 組 × 6 tiles × 16 bytes |

### Head → Template 對應

**1:1 映射**: H00-H19 對應 T00-T19

Template 位置: `0x1ED14 + template_idx × 36`

### 已驗證索引表 (43 筆，Category-local 格式)

所有索引值皆為 Category 內的 local index (0-4)。

**Category 0 (11 筆):**
| 頭像 | H | E | N | M |
|------|---|---|---|---|
| P138 高沛 | 0 | 2 | 3 | 1 |
| P083 孫瑜 | 1 | 2 | 1 | 2 |
| P097 高覽 | 1 | 3 | 1 | 2 |
| P099 袁譚 | 2 | 0 | 1 | 2 |
| P100 袁熙 | 2 | 2 | 1 | 2 |
| P146 馬鐵 | 2 | 1 | 0 | 0 |
| P148 程銀 | 2 | 3 | 0 | 0 |
| P149 李堪 | 3 | 2 | 3 | 1 |
| P117 張允 | 4 | 4 | 4 | 3 |
| P118 蔡和 | 4 | 3 | 4 | 3 |
| P119 蔡中 | 4 | 1 | 4 | 3 |

**Category 1 (10 筆):**
| 頭像 | H | E | N | M |
|------|---|---|---|---|
| P092 陳琳 | 0 | 3 | 1 | 2 |
| P093 田豐 | 0 | 4 | 2 | 4 |
| P095 沮授 | 0 | 4 | 3 | 1 |
| P131 法正 | 1 | 2 | 3 | 1 |
| P135 鄧賢 | 1 | 3 | 1 | 2 |
| P165 張昭 | 1 | 4 | 3 | 1 |
| P166 張紘 | 1 | 4 | 3 | 3 |
| P189 闞澤 | 2 | 2 | 2 | 2 |
| P204 韓玄 | 3 | 0 | 0 | 0 |
| P211 鞏志 | 3 | 0 | 1 | 3 |

**Category 2 (8 筆):**
| 頭像 | H | E | N | M |
|------|---|---|---|---|
| P111 黃祖 | 0 | 2 | 1 | 2 |
| P121 李傕 | 0 | 3 | 4 | 3 |
| P122 蔡邕 | 0 | 4 | 2 | 4 |
| P123 郭汜 | 1 | 0 | 1 | 2 |
| P124 張濟 | 1 | 1 | 4 | 3 |
| P127 徐榮 | 1 | 3 | 0 | 0 |
| P130 董旻 | 1 | 4 | 3 | 1 |
| P168 虞翻 | 3 | 3 | 0 | 0 |

**Category 3 (14 筆):**
| 頭像 | H | E | N | M |
|------|---|---|---|---|
| P081 周泰 | 0 | 2 | 3 | 1 |
| P082 孫翊 | 0 | 3 | 4 | 3 |
| P084 孫桓 | 0 | 3 | 0 | 0 |
| P120 李肅 | 1 | 2 | 2 | 4 |
| P125 華雄 | 1 | 2 | 0 | 1 |
| P128 胡軫 | 1 | 3 | 4 | 3 |
| P129 趙岑 | 1 | 3 | 0 | 0 |
| P147 侯選 | 2 | 0 | 0 | 0 |
| P150 張橫 | 2 | 0 | 1 | 2 |
| P186 周倉 | 2 | 4 | 2 | 4 |
| P182 糜芳 | 3 | 0 | 0 | 0 |
| P195 徐盛 | 3 | 1 | 4 | 3 |
| P214 文聘 | 3 | 3 | 1 | 2 |
| P185 傅士仁 | 4 | 0 | 1 | 2 |

### Head 變體統計 (local index)

| Cat | H | 樣本 | E range | N range | M range |
|-----|---|------|---------|---------|---------|
| 0 | 0 | 1 | 2 | 3 | 1 |
| 0 | 1 | 2 | 2-3 | 1 | 2 |
| 0 | 2 | 4 | 0-3 | 0-1 | 0-2 |
| 0 | 3 | 1 | 2 | 3 | 1 |
| 0 | 4 | 3 | 1-4 | 4 | 3 |
| 1 | 0 | 3 | 3-4 | 1-3 | 1-4 |
| 1 | 1 | 4 | 2-4 | 1-3 | 1-3 |
| 1 | 2 | 1 | 2 | 2 | 2 |
| 1 | 3 | 2 | 0 | 0-1 | 0-3 |
| 1 | 4 | 0 | - | - | - |
| 2 | 0 | 3 | 2-4 | 1-4 | 2-4 |
| 2 | 1 | 4 | 0-4 | 0-4 | 0-3 |
| 2 | 2 | 0 | - | - | - |
| 2 | 3 | 1 | 3 | 0 | 0 |
| 2 | 4 | 0 | - | - | - |
| 3 | 0 | 3 | 2-3 | 0-4 | 0-3 |
| 3 | 1 | 4 | 2-3 | 0-4 | 0-4 |
| 3 | 2 | 3 | 0-4 | 0-2 | 0-4 |
| 3 | 3 | 3 | 0-3 | 0-4 | 0-3 |
| 3 | 4 | 1 | 0 | 1 | 2 |

### Category 系統 (已驗證)

**重要發現：43 筆資料 100% 符合 Category 規則**

所有索引都是 **Category-local** (0-4 範圍)，不是 global。

| Category | Head (local) | Eye (local) | Nose (local) | Mouth (local) |
|----------|--------------|-------------|--------------|---------------|
| 0 | 0-4 | 0-4 | 0-4 | 0-4 |
| 1 | 0-4 | 0-4 | 0-4 | 0-4 |
| 2 | 0-4 | 0-4 | 0-4 | 0-4 |
| 3 | 0-4 | 0-4 | 0-4 | 0-4 |

**Global 轉換公式：**
```python
global_idx = category * 5 + local_idx
# 例: Category 3, H2 → global H17 (3*5+2=17)
```

### 變體索引表

| 表格 | ROM 位置 | 長度 | 值範圍 | 說明 |
|------|----------|------|--------|------|
| T1 | 0x1EFE4 | 174 | 0-4 | Eye local index |
| T2 | 0x1F092 | 174 | 0-4 | Nose local index |
| T3 | 0x1F140 | 174 | 0-4 | Mouth local index |

**計算公式 (已驗證):**
```python
# 從 ROM 讀取 local indices
eye_local = T1[portrait_id - 81]    # 0-4
nose_local = T2[portrait_id - 81]   # 0-4
mouth_local = T3[portrait_id - 81]  # 0-4

# 轉換為 global indices (如果需要)
eye_global = category * 5 + eye_local
nose_global = category * 5 + nose_local
mouth_global = category * 5 + mouth_local
```

---

## 待解決問題

1. **portrait_id → Head 映射**: 如何從 portrait_id (81-254) 決定使用哪個 Head?
   - 已知 Category 由 Head 決定: `category = head_idx // 5`
   - 待找出 portrait_id → head_idx 的映射表或公式
2. ~~**變體索引表解讀**~~: ✓ 已解決 - T1/T2/T3 是區內偏移 (0-4)，加上 `category * 5` 得到實際索引
3. **H09/H12/H14 無樣本**: 這三個 Head 目前沒有已知武將使用

---

## 下一步待辦

- [ ] 解析 portrait_id → Head 的映射機制
- [ ] 驗證變體索引表計算公式
- [ ] 收集 H09/H12/H14 的武將樣本
- [ ] 城市名稱表位置
- [ ] 未確認欄位 (Body/Luck) 遊戲驗證

---

## 工具

| 工具 | 說明 |
|------|------|
| `mob_portrait/variant_explorer/` | 大眾臉頭像探索器 |
| `mob_portrait/variant_explorer/extract_components.py` | 資產提取腳本 |
