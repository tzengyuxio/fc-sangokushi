# ROM_STRUCTURE.md — FC 三國志 ROM 檔案結構

## 檔案基本資訊

| 項目 | 值 |
|------|------|
| 檔名 | `Sangokushi (Japan).nes` |
| 檔案大小 | 262,160 bytes (256 KB + 16 bytes header) |
| 格式 | iNES (.nes) |
| Mapper | 1 (MMC1) |
| PRG ROM | 256 KB = 16 banks × 16 KB |
| CHR ROM | 0 KB (使用 CHR-RAM) |

---

## iNES Header (0x00000 - 0x0000F)

| 偏移 | 大小 | 內容 | 說明 |
|------|------|------|------|
| 0x00000 | 4 | `4E 45 53 1A` | "NES" + 0x1A 魔數 |
| 0x00004 | 1 | `10` | PRG ROM 大小 (16 × 16KB = 256KB) |
| 0x00005 | 1 | `00` | CHR ROM 大小 (0 = CHR-RAM) |
| 0x00006 | 1 | `10` | Flags 6 (Mapper low nibble = 1) |
| 0x00007 | 1 | `00` | Flags 7 |
| 0x00008-0x0000F | 8 | `00...` | 保留 |

---

## PRG ROM Banks 概覽

PRG ROM 偏移計算: `file_offset = bank × 0x4000 + 0x10`

| Bank | 檔案偏移 | CPU 地址 | 已知內容 |
|------|----------|----------|----------|
| 0 | 0x00010 - 0x0400F | $8000-$BFFF | 程式碼、文字資料 |
| 1 | 0x04010 - 0x0800F | $8000-$BFFF | 程式碼 |
| 2 | 0x08010 - 0x0C00F | $8000-$BFFF | 程式碼 |
| 3 | 0x0C010 - 0x1000F | $8000-$BFFF | 程式碼、tile 資料 |
| 4 | 0x10010 - 0x1400F | $8000-$BFFF | Tile 圖形資料 |
| 5 | 0x14010 - 0x1800F | $8000-$BFFF | Tile 圖形資料 |
| 6 | 0x18010 - 0x1C00F | $8000-$BFFF | Tile 圖形資料 |
| 7 | 0x1C010 - 0x2000F | $8000-$BFFF | Tile 圖形資料 |
| 8 | 0x20010 - 0x2400F | $8000-$BFFF | **假名字體 tile** |
| 9 | 0x24010 - 0x2800F | $8000-$BFFF | 資料表 |
| 10 | 0x28010 - 0x2C00F | $8000-$BFFF | 資料 |
| 11 | 0x2C010 - 0x3000F | $8000-$BFFF | Tile 圖形資料 |
| 12 | 0x30010 - 0x3400F | $8000-$BFFF | 資料 |
| 13 | 0x34010 - 0x3800F | $8000-$BFFF | 資料 |
| 14 | 0x38010 - 0x3C00F | $8000-$BFFF | **武將資料表、姓名表** |
| 15 | 0x3C010 - 0x4000F | $C000-$FFFF | 固定 Bank (程式碼、中斷向量) |

---

## 已解析資料區塊

### Bank 14: 武將資料表

| 偏移 | 大小 | 內容 |
|------|------|------|
| 0x38010 - 0x38013 | 4 | 表頭 `4C 00 00 00` |
| 0x38014 - 0x39113 | 4,352 | 武將資料 (256 筆 × 17 bytes) |
| 0x39114 - ... | ? | 城市資料? (待分析) |

**武將記錄結構 (17 bytes):**
```
+0   Age          年齡 (signed byte)
+1   Body         體力 (15-100)
+2   Intelligence 智力 (15-100)
+3   Military     武力 (15-100)
+4   Charisma     魅力 (15-100)
+5   Luck         運氣 (15-100)
+6   Loyalty      忠誠 (12-100)
+7   Status+Navy  身份/水軍 bitfield
+8,9 Troops       兵士數 (little-endian 16-bit)
+10  City         城市 ID (0-55)
+11  Faction      勢力 ID (0-14)
+12-16 Separator  固定 0A 0A 0A 00 00
```

### Bank 14: 武將姓名表

| 偏移 | 大小 | 內容 |
|------|------|------|
| 0x3A310 - 0x3A313 | 4 | 表頭 `4C 00 00 00` |
| 0x3A314 - 0x3B823 | 3,855 | 姓名資料 (257 筆 × 15 bytes) |

**姓名記錄結構 (15 bytes):**
```
+0-7   Name      假名 (半角片假名, Shift-JIS 0xA6-0xDF)
+8-14  Unknown   用途未知 (可能是漢字指標或顯示資料)
```

### Bank 8: 假名字體

| 偏移 | 大小 | 內容 |
|------|------|------|
| 0x22CA0 - ... | ~1,024+ | 片假名字體 tile (8×8 pixels, 16 bytes/tile) |

**字體特徵:**
- 按五十音順序排列 (ア、イ、ウ、エ、オ...)
- 每個 tile 包含陰影效果
- 約 50+ tiles (清音 + 濁音符號 + 特殊字元)

---

## 待分析區塊

| 偏移 | 推測內容 | 備註 |
|------|----------|------|
| 0x39114 - 0x3A30F | 城市資料? | 在武將表與姓名表之間 |
| 0x0ADA8 附近 | 遊戲文字 | 有大量半角片假名 |
| Banks 3-8 | 頭像 tile | 分散存放，需要拼接表 |

---

## 編碼參考

### 半角片假名 (Shift-JIS)

| 範圍 | 字元 |
|------|------|
| 0xA6-0xAF | 小字 (ｦ ｧ ｨ ｩ ｪ ｫ ｬ ｭ ｮ ｯ) |
| 0xB0 | 長音 (ｰ) |
| 0xB1-0xBF | ア行-サ行 (ｱ-ｿ) |
| 0xC0-0xCF | タ行-ノ (ﾀ-ﾉ) |
| 0xD0-0xDD | ハ行-ン (ﾊ-ﾝ) |
| 0xDE | 濁點 (ﾞ) |
| 0xDF | 半濁點 (ﾟ) |

---

## 版本歷史

- 2024: 初始分析，解析武將資料表與姓名表
