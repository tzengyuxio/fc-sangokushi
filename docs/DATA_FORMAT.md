# DATA_FORMAT.md — 武將資料表格式文件

## 總覽

```
iNES Header (16 bytes)
├── 0x00000–0x0000F
PRG ROM (256 KB = 16 banks)
├── Bank  0: 0x00010–0x0400F
├── Bank  1: 0x04010–0x0800F
├── ...
├── Bank 14: 0x38010–0x3C00F  ← 武將資料表在此
└── Bank 15: 0x3C010–0x4000F  ← 固定 bank (含 bank 切換程式)
```

## 武將資料表

### 表頭 (4 bytes)

```
偏移        Hex          說明
0x38010     4C 00 00 00  表頭, 0x4C = 76 (意義未確認)
```

### 資料區 (256 筆 × 17 bytes = 4352 bytes)

```
偏移範圍              說明
0x38014 – 0x39113     256 筆武將記錄
```

### 單筆記錄 (17 bytes)

```
Byte  偏移   型別         欄位名        值域        說明
────  ─────  ───────────  ──────────    ─────────   ─────────────────────────
B0    +0     int8 signed  Age           -28 ~ 65    年齡 (負=未出生)
B1    +1     uint8        Body          15 ~ 100    體力/壽命 (推測)
B2    +2     uint8        Intelligence  15 ~ 100    智力
B3    +3     uint8        Military      15 ~ 100    武力
B4    +4     uint8        Charisma      15 ~ 100    魅力
B5    +5     uint8        Luck          15 ~ 100    運氣/義理 (推測)
B6    +6     uint8        Loyalty       12 ~ 100    忠誠度
B7    +7     bitfield     Status+Navy   0 ~ 3       見下方說明
B8    +8     uint8 (lo)   Troops LSB    —           兵士數低位
B9    +9     uint8 (hi)   Troops MSB    —           兵士數高位
B10   +10    uint8        City          0 ~ 55      城市 ID
B11   +11    uint8        Faction       0 ~ 14      勢力 ID
B12   +12    uint8        Separator     0x0A        固定分隔符
B13   +13    uint8        Separator     0x0A        固定分隔符
B14   +14    uint8        Separator     0x0A        固定分隔符
B15   +15    uint8        Separator     0x00        固定分隔符
B16   +16    uint8        Separator     0x00        固定分隔符
```

### B7 Bitfield 詳解

```
bit1  bit0   B7值   意義              人數
────  ────   ────   ────────────────  ────
 0     0      0     一般・非水軍       102
 0     1      1     一般・水軍         139
 1     0      2     統領・非水軍        3  (軍師)
 1     1      3     統領・水軍         12  (君主)
```

### 兵士數計算

```
Troops = B8 + B9 × 256
```

例: B8=0xF4, B9=0x01 → 0xF4 + 0x01×256 = 244 + 256 = 500

### 記錄偏移計算

```
第 N 筆記錄的檔案偏移 = 0x38014 + N × 17
```

### 年齡與出生年推算

遊戲起始年份為 189 年:
```
出生年 = 189 - Age
```
負年齡角色的出生年 = 189 + |Age| (即 189 年之後才出生)

## 武將姓名表

頭像索引存放於姓名表 (0x3A314)，非武將資料表。

### 姓名記錄結構 (15 bytes)

```
Byte  偏移   說明
────  ─────  ─────────────────────────
+0-7  +0     假名 (半角片假名, 8 bytes)
+8    +8     漢字1 tile ID
+9    +9     漢字1 Page (0=Page0, 1=Page1)
+10   +10    漢字2 tile ID
+11   +11    漢字2 Page
+12   +12    漢字3 tile ID
+13   +13    漢字3 Page
+14   +14    頭像索引 byte
```

### 頭像索引計算

```
portrait_index = name_record[+14] - 1
```

範圍: 0-80 (共 81 個頭像)

### 排列索引計算

```
arrangement_index = portrait_index  (1:1 對應)

- 排列表 (0x1B0D4) 正好 81 個條目，與頭像數量相同
- 36-tile 標準頭像 (32 個): 使用標準排列 (STANDARD_LAYOUT)
- 其他頭像: 直接用頭像索引查找排列表
```

### 驗證範例

```
序號   姓名     頭像  排列
  1    曹操       4     4
  2    孫堅      20    20
  3    劉備       0     0
  4    袁紹      44   STD
 43    關羽       2     2
174    諸葛亮     1     1
```

---

## 驗證資料

以下為已透過遊戲確認的欄位值:

```
序號   姓名     年齡  智力  武力  魅力  水軍  兵士   頭像  排列
  1    曹操      35    93    94   100    ✓   10000    4     4
  3    劉備      29    95    63    99    ✓     500    0     0
 43    關羽      28    83    99    70    ✓     500    2     2
 44    張飛      23    32    99    33    ✓     500   43   STD
 47    孫亁      25    78    36    34    ✗    1500   40   STD
173    徐庶      17    96    37    81    ✗     100   71    71
174    諸葛亮     8   100    72    97    ✓    2000    1     1
```
