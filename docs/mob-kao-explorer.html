<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大眾臉頭像探索器 - FC 三國志</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background: #1a1a2e;
            color: #eee;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #ffd700;
            text-align: center;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 30px;
        }
        .panel {
            background: #252540;
            border-radius: 12px;
            padding: 20px;
        }
        .panel h2 {
            color: #00d4ff;
            margin-top: 0;
            font-size: 18px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        .panel h3 {
            color: #8f8;
            margin: 15px 0 10px 0;
            font-size: 14px;
        }

        /* Head selector */
        .head-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 15px;
            position: relative;
        }
        .head-btn {
            background: #333;
            border: 2px solid #555;
            color: #ccc;
            padding: 8px 4px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            position: relative;
        }
        .head-btn:hover {
            background: #444;
            border-color: #888;
        }
        .head-btn.selected {
            background: #1a4a1a;
            border-color: #4f4;
            color: #4f4;
        }
        /* Hover preview tooltip */
        .head-preview {
            display: none;
            position: fixed;
            z-index: 1000;
            background: #1a1a1a;
            border: 2px solid #666;
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .head-preview canvas {
            display: block;
            image-rendering: pixelated;
        }
        .head-preview .label {
            text-align: center;
            color: #aaa;
            font-size: 11px;
            margin-top: 4px;
        }

        /* Variant selectors */
        .variant-scroll {
            max-height: 200px;
            overflow-y: auto;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 10px;
        }
        .variant-item {
            display: flex;
            align-items: center;
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
            transition: background 0.2s;
        }
        .variant-item:hover {
            background: #333;
        }
        .variant-item.selected {
            background: #2a4a2a;
            outline: 2px solid #4f4;
        }
        .variant-item canvas {
            image-rendering: pixelated;
            margin-right: 10px;
        }
        .variant-item span {
            font-size: 12px;
            color: #aaa;
        }

        /* Preview area */
        .preview-area {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #portrait-canvas {
            image-rendering: pixelated;
            border: 3px solid #555;
            border-radius: 8px;
            background: #000;
        }
        .preview-info {
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #888;
        }
        .preview-info code {
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
            color: #ffa;
        }

        /* Template visualization */
        .template-vis {
            display: grid;
            grid-template-columns: repeat(6, 44px);
            gap: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        .template-cell {
            background: #333;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        .template-cell.variant {
            background: #553;
            color: #ff8;
        }

        /* Info panel */
        .info-section {
            margin-top: 20px;
        }
        .info-table {
            width: 100%;
            font-size: 12px;
        }
        .info-table td {
            padding: 4px 8px;
        }
        .info-table td:first-child {
            color: #888;
        }
        .info-table td:last-child {
            color: #8f8;
            text-align: right;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        .btn {
            background: #444;
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #555;
        }
        .btn.primary {
            background: #1a6a1a;
        }
        .btn.primary:hover {
            background: #2a8a2a;
        }

        /* Known combinations panel */
        .known-list {
            max-height: 600px;
            overflow-y: auto;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 10px;
        }
        .known-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
            background: #252525;
            transition: background 0.2s;
        }
        .known-item:hover {
            background: #333;
        }
        .known-item .name {
            flex: 1;
            font-size: 13px;
        }
        .known-item .idx {
            font-size: 11px;
            color: #888;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Hover preview tooltip -->
    <div class="head-preview" id="head-preview">
        <canvas id="head-preview-canvas" width="96" height="96" style="image-rendering: pixelated;"></canvas>
        <div class="label" id="head-preview-label">H00</div>
    </div>

    <h1>大眾臉頭像探索器</h1>

    <div class="container">
        <!-- Left Panel: Head & Variant Selection -->
        <div class="panel">
            <h2>Head (H00-H19)</h2>
            <div class="head-grid" id="head-selector"></div>

            <h3>Eye (0-4)</h3>
            <div class="variant-scroll" id="eyes-selector"></div>

            <h3>Nose (0-4)</h3>
            <div class="variant-scroll" id="noses-selector"></div>

            <h3>Mouth (0-4)</h3>
            <div class="variant-scroll" id="mouths-selector"></div>
        </div>

        <!-- Center Panel: Preview -->
        <div class="panel preview-area">
            <h2>頭像預覽</h2>
            <canvas id="portrait-canvas" width="288" height="288"></canvas>
            <div class="preview-info">
                <p>Category: <code id="info-cat">-</code></p>
                <p>H: <code id="info-head">-</code> | E: <code id="info-eyes">-</code> | N: <code id="info-noses">-</code> | M: <code id="info-mouths">-</code></p>
                <p>Global: H<code id="info-head-global">-</code> | Template: <code id="info-template">-</code></p>
            </div>

            <div class="controls">
                <button class="btn" onclick="randomize()">隨機組合</button>
                <button class="btn" onclick="toggleGrid()" id="grid-btn">顯示格線</button>
                <button class="btn primary" onclick="downloadPortrait()">下載頭像</button>
            </div>

            <div class="info-section">
                <h3>Template 排列</h3>
                <div class="template-vis" id="template-vis"></div>
            </div>
        </div>

        <!-- Right Panel: Known Combinations -->
        <div class="panel">
            <h2>已知組合 (遊戲內)</h2>
            <div class="known-list" id="known-list"></div>

            <div class="info-section">
                <h3>Head 資訊</h3>
                <table class="info-table">
                    <tr><td>ROM 基底</td><td id="info-base-addr">-</td></tr>
                    <tr><td>Tile 數量</td><td id="info-tile-count">-</td></tr>
                    <tr><td>Pattern 類型</td><td id="info-pattern">-</td></tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        // === EMBEDDED DATA START ===
        // Raw NES tile data (16 bytes = 32 hex chars per tile)

        const PALETTE = [
          [0, 0, 0],        // Index 0: Black
          [247, 216, 165],  // Index 1: Light skin
          [234, 158, 34],   // Index 2: Dark skin
          [255, 255, 255],  // Index 3: White
        ];

        const HEAD_TILES = [
  // H00
  ["55aa55aa55aa54aaaa55aa55aa55aa54", "50a043831b658fbba24883439a658a91", "55a954aa54a854a8a955aa54a954a854", "6981fed16e6f9f1f2801aa5120408000", "00fccb6dfed7fb7902fc8a45aa55aa51", "00000080be67b0f520800200be45a055", "87ff78e77c83ffff8255284528000000", "2f2b7f833dfcfcfc2a012a0100020303", "000000000080c0602080020822088248", "bf5f2e2f0d1e150cbf5f2eaf0d9e150c", "b0e864eaa2d45428a2402040a2540080", "0e0a090e0d2548882e8a298e0da54888", "55a955aa54aa54aaa955a854aa54aa54", "54aa55aa55aa55aaaa55aa55aa55aa55", "392a3c391b327529a982ac918a902001", "40cac595108a952a004a85151204aa15", "632764286226644c2205200022042044", "152a55aa552a150a2a552a552a952a95", "55aa54a840000187aa55aa5482002085", "3ce010f0f8f87cbe284019fbf9fc7ebf", "3800602030180e07aa00200022100a25", "05020100000000c00a05228102882240", "018c1e3ffce0031f60cc9f3ffffcc31f", "fc7f07000e7ef8c0a85502e08f7ffffc"],
  // H01
  ["555555555554555477dd77dd77dc74dc", "574c58302d5935a170c840a001050901", "555552525556565574d572d074d672d5", "495dbfb16e5f9f1f0955bb3160408000", "7078fcfeff8703217070e8d4ea857a65", "00000000702e9580000000000050aa01", "210183c7ff4644806441b2c5aa441113", "9cbfff810c1c7cfc9c3dba0132e38303", "a83e0a1d2a140080042a550800008040", "804020a080c080603f1f0e8f4d9e552c", "462993e6ee7c6c3826099244aa542890", "20602048142c5c9c4e2a410201050814", "555452525454545471d472d874dc76dc", "555554555555555574dd76dd77dd77dd", "393a3c381938792ba890a89088902801", "3878f8d03064d5952852a955224c971d", "60226723612060412000220120002040", "d565e5d5951515d5974da75db71d379d", "555554544204090777dd76dc40000005", "3ce01818383c3e9f284019fbf9fc7ebf", "82046a2732180e070100210220100a25", "05e5811d20c008c007a5430950801040", "018c1f3ffcf0c31f60cc9f3ffffcc31f", "fc7f07000f7ef8e0a85502e08f7ffffc"],
  // H02
  ["aaffaaffaaffaafe55aa55aa55aa54aa", "a6ec91cc944ac42151a8508108042255", "a9fda8fda9fea9f854a854a854aa55aa", "118f5c332f5f1f9fa14d9830a0400080", "6a00f7a251aa01fc15000055a25102fd", "2a3fc28c14aa1428142a01508a14a815", "565700ffffffffff0255000000000000", "01f2fc0ff1fcfcf80851a80500020307", "04c1a4f928de4aa6088250aa140aa452", "aa5b2a2b424f4acf110a010a454a158a", "4289152a94a85008a0458814aa104089", "cacf8a8f0a4f2a2f850a050a450a452a", "a8f8a8f8a8f8a8f853aa52ab52aa52ab", "a8f8a8feaaffaaff52aa55aa55aa55aa", "3820181820185800baa09b92a0934a00", "2a2f2a1f0a1f2a3f05aa850a958a15aa", "58186030602064410b12201628022040", "2a3f2aff2a3f2a1f952a55aa552a950a", "aaffaaf88010411755aa54a840200805", "0c3870e8c89c1e8f8810214b993c7ebf", "0001642134190c2f8802280020120825", "0a174201441040118522092088200822", "478b1c3ef8c0031f62c99c3ffffcc31f", "84c1e4603439381c8042a8422012a8d4"],
  // H03
  ["5500510255015400aa00a802a901aa00", "5000400000c0c0e0a70bad171fdf9f4b", "5501540055005400a901aa00a800a800", "6038dfe35c5f9f1f2710cb4100408000", "020c0f070700000151a44bc5e2e0a041", "aa540ae1fecfc7cf55001160aa4587cd", "03078ffffc03ffff83078e75a8000000", "9c387f833dfcfcfc98306a0100020303", "0855a21972e5ca650000411065c09440", "bf5fae2f0d5e954c8040202040004000", "b279ec06cefd7c38a150a9048e5c3890", "ae4aa94e8d2568c840004000402060c0", "5501550054005400a801a800aa00aa00", "5400550055005500aa00aa00aa00aa00", "393b3f3f1e3d7f7ea993ae9d9ab56a54", "c08a0515908015008000000082002a00", "1c3b7e7e183e7c7d18316a5c18346954", "15005500558015802a002a002a002a40", "5500540042106187aa00aa0080040045", "3ce01838783c3e9f284019fbf9fc7ebf", "3a00642136190e07a804200021100a25", "05102180429822c10a00124000041040", "010c1e3efcf0831f60cc9f3ffffcc31f", "fc7f07000c7cfce0a85502e08f7ffffc"],
  // H04
  ["0000000202020202a9fda9f8aaf8aaf8", "04001302342405c4f0e0d3c2849405d4", "0000020200020200a8fcaafaa8f8aafc", "e5767bbd402f9f1fe1542a1500408000", "00fc0f190a1576b600fc0a110a152296", "400140be95ca404b80220000aa550053", "23c67df77c83ffff22463c7528000000", "d7cfdebc01fefcfc864d9a3500000303", "4001451103134226882189018a032a54", "984c262244020480a351282402048823", "15044da8499a50112445a849aa501091", "008000983068d0a08a2f8213a2438217", "0101010000000000a8fda8feaafeaafe", "0000000000000000aaffaaffaaffaaff", "33260c18013c6242a204889180b56240", "502040a040800080224faa4f8a5faa3f", "464a564e565e6c3d4248524402542814", "00000000000000002a7f2aff2a3faa1f", "0000000000104107aaffaafc80200805", "3ce01818383c1e8f284019fbf9fc7ebf", "0001642134190e078002280020100a25", "00104000441000c18a270a2188200842", "418c1f3ffcf0c31f60cc9f3ffffcc31f", "fc7f07000e7efce0a85502e08f7ffffc"],
  // H05
  ["44114411441044118822882288228822", "61305c3060c00004793c9c3060c00000", "44114410441044108822882288228822", "1a1f3f3f7f7f7f7f0000000000000000", "c000000000000215f000000000000000", "030000000000f0f80300000000000000", "af7fffffffffffff0000000000000000", "f8f8f8f8f0f0f0f0040606060e0e0c0e", "3773190c00000000b773190c06010000", "44918491041104e108a288a208c228e2", "e451041104512411e842082208426872", "44104411441144118822882288228822", "44114411441144118822882288228822", "000000010c122202000000000080081c", "449144114411441148a2082288228822", "060605054d6931000000212911034381", "44114411449184918822082208a288a2", "44114410400ce8d888228822800ce8d8", "0000462722206061090d1e0f86844243", "c4d144d104114411c8c2c8c208028822", "c1c0c080800000008180808000000000", "4411441104101b1b0822082208101b1b", "00000000000000000000000000000000", "00000000000000000000000000000000"],
  // H06
  ["0000000200010000abf9a9faa8fdaafe", "202020400041097582a8800840010521", "0000000000000000aafeaafeaafeaafe", "887fa08f3f7f7f7f002a508000000000", "0000000000c0c8d82088228822c0d4c8", "000000000000807c2288028802084228", "02ff00feffffffff01aa010000000000", "82f8aa0fd0f0f0f005a8550a01080c08", "20242a550a952a5508a0440055805500", "4011441040008040802280210a23020f", "2ad52ad5aa752a1c1580058041201008", "8040a040800080004a0f520f2a3f2a7f", "0000000000000000aafeaaffaaffaaff", "0000000000000000aaffaaffaaffaaff", "0a0602000c122202040200000000081c", "00000000000000002a7faaffaaffaaff", "02020404444868700404202918130207", "0000000000084088aaffaafea004a850", "7070300000206060020b4a3782874243", "c0c0c080800000008080808000000000", "000000000000110aaaff2a3f0a100a11", "00000000000000000000000000000000", "00000000000000000000000000000000", "00000000000000000000000000000000"],
  // H07
  ["55555443505050542288008020882280", "5503fa80400000002001020000800000", "4e505454545155552080208020802080", "0014383d3e7f7f7f0000000000000000", "5502bd00000000002a41a80000000000", "2ea86e0000000000aa002a0000000000", "00000553afffffff0000000000000000", "00b0f8f8f8f0f0f000000004060e0e0e", "a500bf0005010100a200800002000000", "555584f1010101012208020002882288", "01014505450545552208220822080208", "51454555555555552280228822882288", "55555555555555552288228822882288", "0000001c326242020000000000040400", "45454555555555550288228822882288", "c2c60505edf931050818989800000280", "55555554500cc89022882288200ce8d8", "050555058585414102084228a2a06260", "8180808000000000c0c0c08080000000", "55555515050010132288220802101b1b", "00000000000000000000000000000000", "00000000000000000000000000000000", "00000000000000000000000000000000", "00000000000000000000000000000000"],
  // H08
  ["00000000000000002288228822882288", "01000000000000032088208020800000", "1f3f3f7f7f7f7f7f0000000000000000", "d0000000000000ff2000000000000000", "01000000000000f00200000000000000", "fffffffffffbefcf0000000000040010", "f8f8f8f8f8f8f8f0070707070606040e", "1723110804000000a050080402010000", "0080008000c020a02208a20822080248", "00000000000000000080000000000000", "4000000040206030a248220802480240", "000000001c322242000000000000081c", "50800000000080c02208228822082208", "02042524496261000412080914091261", "7028502050a080808050225022080208", "00000000000440502288228820082088", "01005422242261620805100482814241", "40c040c0602060308208820882480240", "c1c0c080800000008080808000000000", "10b0182808101111a200221002000208", "00000000000000000000000000000000", "00000000000000000000000000000000", "00000000000000000000000000000000", "00000000000000000000000000000000"],
  // H09
  ["66996699669960965555555555555154", "2041074c183030b04401460c5a302290", "65986498669866985050545454545454", "3090c09f3f7f7f7f2210800000000000", "00e1fc060301010101e0a90422090009", "080800100080b08e000810001000a004", "010100ffffffffff2089000000000000", "81800080f0f0f0f0a0082200080e0c0e", "2a690a5f82b6801e0528510a51a2001e", "a6e9865186b1261945a5550555a50511", "bf7060c040000000ba7062c802080200", "fa111629262946a9a915058525850505", "66996699669966995455555555555555", "66996699669966995555555555555555", "0100000e193121010000000000800a10", "46996699661966191515555555555555", "0002200560712609050406090d095565", "66996698600ce8d855555554500ce8d8", "06094629262162610505150585854141", "c0c0c080800000008180808000000000", "6699661906101b1b5555551505000010", "00000000000000000000000000000000", "00000000000000000000000000000000", "00000000000000000000000000000000"],
  // H10
  ["0000000000000e2a2288228822800085", "00c080cf90a1a021489d408000820800", "110004010400000002812082208a2088", "04a1500f3f7d7e7fa800800000020100", "0060f0af50000400880d0050a0000020", "0000008040201023aaef2a1e8a46a010", "041000fffff9e7ff8022000000061800", "13264400f0f8f8f0a01022000007070e", "246140d18000d08a8820088200022015", "40004010401000208228820082200210", "00104410041144200020880208022042", "5020500040004000aa10020882080228", "00000000000000002088228822882288", "00000000010001012288228820892088", "44684562142234222804201422950215", "40000000000000000208220822082208", "35223722332a313b0214001508100a00", "0080008000804000a208a208a2488248", "01010307050a1b2a2088208020850081", "5796356ecd0aa4c20041820122044284", "113a15389db81d382a012a0520052205", "c080c0c0603058a8020802088240a210", "9d9a949a955a14d902850a850a054a84", "54ee77b30970aafb88008040822051aa"],
  // H11
  ["555555555555515677dd77dd77dd71d4", "0a112f5617156dec10810a1452152844", "575355555454545472d974dd76dc76dc", "a6bfc09f3f7f7f7fa215800000000000", "0ae1fc36d3979b191140a91482158a11", "a2458a550a85703e5500450055002114", "33ff00ffffffffff2255000000000000", "37f77f87f0f0f1f022552a05080e0d0e", "801184110411401e0820082008200014", "5555551515150519775d771db71da711", "ffbda3e6751cc6f3aa15a2442114c281", "f9f515c5c53575c5ab5507cdc715274d", "545555555555555576dd77dd77dd77dd", "555555555555555577dd77dd77dd77dd", "f5ea304e59312101e080204040000a10", "9595555555555555971d77dd775d775d", "0102220505497565840484896931070d", "55555554500c000877dd77dc7000e0c0", "05055525a5a56961070d570d87854341", "ddd0c1b9b51654de8180808000000000", "5555551505a0a84877dd771d07000303", "00000000000000000000000000000000", "00000000000000000000000000000000", "00000000000000000000000000000000"],
  // H12
  ["0000000000000000aaffaaffaaffaaff", "703803040b172f1f79bc83e4a8d0a080", "0000000000000000aaffaafeaafeaafe", "5f3fbf7f7f7b7d7f4000800000040200", "300f00abfffffffff00f000000000000", "038450f8fcfcfcfc0384080703030303", "fffffffffff0cfff0000000000092000", "fcf8f8f0f0f8f9f00307070f0f06050e", "171389643208181eb773996cb6c9d8d8", "0080000000c020202abfaabf2adf2aef", "343e3d785eff7cf7b4b8b87050f860f0", "2040000000000000ea5f2a7f2a3f2a3f", "5ef9406e5931210140f0406040000a90", "4040602030381c084a5f6aef723b3c3b", "0102220545597169048404092923030b", "40c060600000000052cfea6f4a3f2a7f", "00000000000ce8d8aaffaafea0000000", "01004404848442420b091d2d25246262", "808080c040404060aabfaadfcadfcaef", "8080800000000000e0c0c08080000000", "203010180c001013eaf7723b0c101b1b", "00000000000000000000000000000000", "00000000000000000000000000000000", "00000000000000000000000000000000"],
  // H13
  ["5400540054065300aa00aa00a100a800", "808081a2404738c0828880a940400005", "5502510055005400a800a801a800aa00", "15a2409f3f7f7f7f2051a00000000000", "00a0500804f807880248a21000000050", "020605050a0ac03e2286248428080100", "51a201fefffffff78a51000000000008", "41aa5502f8f8f1f08054aa0500060d0e", "a6996618638e38211104114410400004", "598c6518a1d065b00240104012000200", "c6314ca3540aa5fa01008050a81582c1", "598065009540258002400a402a008a40", "5400550055005500aa00aa00aa00aa00", "5500550055005500aa00aa00aa00aa00", "e5fa704e5931214180f0404040800a10", "1580550055005500aa002a002a002a00", "01420204052835200404240868504240", "55005500550055002a00aa00aa00aa00", "5500550050084090aa00aa00a00ca858", "05001500050041400a004a20a2a06260", "c0a0908804424120e0f0d88c86c34120", "5500550005101112aa002a000a109ad9", "00000000000000000000000000000000", "00000000000000000000000000000000"],
  // H14
  ["441142124515431188218a2284258221", "175d77d867df350506196698659d3505", "43114410441044108a21882088228822", "513cbe7f7f797e7f4000800000060100", "77dd7700effffdba669966004cdcd9b2", "77dd771dc3fcd2846699661942c89081", "b5ab1ffffff867ff3420000000018800", "78f8f8f0f078f9f00307070f0f86050e", "31cc73dc775d172d308c6398661906a9", "4451049144a144d14802088248a24892", "37393d785eff7cf7b6b9b07854f860f0", "64c970d170597441608a6092601a6002", "44114411441144118822882288228822", "dbfe406e19312101d8e0406000800a10", "4491245128351801488228d268747832", "0102020404487468040424096931050b", "0411049184a144512842088288a2c8d2", "44114410400ce8d888228822800ce8d8", "0800100c040440400b03512da5a56161", "5449446164212421d0dad0e2e8e2e8e2", "c080808000000000c1c0c08080000000", "2421242104001313e8e2682208101b1b", "00000000000000000000000000000000", "00000000000000000000000000000000"],
  // H15
  ["0000000000040406aaffaaf7a2f5a6f7", "0000000708142111aafea8f5a8d52b83", "0203030101000001abfbabfda9fca8fd", "00104400b0a8756a8a20080280940a15", "38c0c0fe010004012840805400c22002", "00000000c0384c160000000080108824", "04010411440215ae2042880288210a51", "4211440050a955a88a2188022855a956", "3b0d0201000438f83a0d020100063cfc", "fceede3f4f677736a9448a150a452214", "f07060e0c0881838f87870f0e0e0c890", "153f351f3e363b1b001520152a142a11", "0101010109090d05a9fda9e5a9e1a9e5", "0703030505030303a3f1a3f5a1f9abf9", "68786878687868732850685068506853", "382c24504830e0c0280420514813a247", "6f7e7c797a7c5b5e6e7c787068504a54", "9060e08000008000924f2a1f0a3faa3f", "0101000000000000a8fdaaffaaffaafe", "000113869c79f4e1a8e112848852a042", "607e3c032c0c66266054280128046224", "00000080e03008040a0f0a0782030201", "4343c181841044104241c08188220820", "000cb0c1e376381e0000a040a0542814"],
  // H16
  ["5500252035105908aa008a20a2109208", "5400500748172e5daa00a0078817ae4d", "4c0556024f0d1f5fa801a000a1011959", "bd7e7f5a182a49229d1e171210092a51", "0f3c00fe01fe3fdf0fbc00fe01c223d1", "00000000c038ccf602082000c2388c86", "df3fffab03ab52a8d131f3a30252aa51", "fbfdfec7932951a8830100002854ac56", "330d020100000000308c228922880208", "95c0d1440d5835602a00080408502240", "0081c367ad9fb77f2089c26428102060", "c5a065e0e5f0f5f88a000a000a0022c0", "2f174b155f1d5f11ad178b0581018f11", "0f730f1d4b074d1b8f710305a305a911", "7f7f7c637e7f7f61636f7c637e607861", "f18e71c879f0f5f0800c608002000280", "7e797f6779767d6e7e61786478666160", "15e01ee0c540956002c018000a008a60", "3701520254045100a101aa02a404aa00", "540103061c78f0e0a80102841833c207", "777b3d06030904067048040221002020", "990005002590090402000a0002800280", "030301010000000002428181aa002a7c", "010080c0e070381e20082288c2603018"],
  // H17
  ["55555555555555502288228822882288", "55545047582454942288208718a54495", "57501311150524142788228900890090", "34da71ca1dba753a259a618422850a45", "000000fe0102c282000000fe017aeaca", "00000000c0384cd700000000c0384c97", "0205080255aa5fba8af50805aa55a045", "71dc778551a854a861986601a856aa56", "3a0d020100000000390c020100000000", "95d59515555555154288420822082208", "fc0070d870c84098fc00609860805090", "15151109011169952208220012104a50", "44594051464142491191019515812185", "40555251565152512185218124892185", "60196608611066185151544451505554", "25156585659555151250424842484248", "60006611601162185140555541515054", "15951555555515152208220822082208", "56515650515555542585248420882288", "54411280841b64842081118494525444", "66192619060026205455151514004424", "15050505a53109050208020042200200", "02418081aa2202444101418114224400", "010c2081621620180008104041521014"],
  // H18
  ["aa55aa55aa54a8535500550055005502", "aa54a04f28e180115500500a10a00820", "a24da850a85188525408400250024402", "0410450a1d3a752a88008215a2050a55", "000000ff000044003dd400aa00028822", "00000080a80f401000000080500a0122", "440055aa55aa55aa8800aa55aa55aa55", "440004a150a950a080220840a854ac5e", "700c0301000080700300000000014120", "6a350295ca554a1585c0450015001580", "080c4200401040101028840088200018", "2a150a150a1502219540d540d5408518", "8249a4118845a0095201092553090531", "8041a041a451a0454d051b01410d1301", "010658004310400130414658604f5840", "82154221021500816580411ce1000178", "5800400841104804475867506e435448", "0215420102550a15850085f80180d500", "a841a255aa55aa544509440055005400", "a84102868878a0e050001182142b55a7", "42100001080c02067452200004084422", "0a050ae522090201150005a015080100", "02030001000000004142c1009c365c74", "000ca0c1a276281e010810804122100a"],
  // H19
  ["77dd77dd77dc73db2288228822882388", "74d061c01fffe010208021801fffe004", "74d872d974dd44d42088208821880180", "26996699608a756a1004114400150a15", "7efdfa00ffff008872cc9800ffe00044", "c0000000f0ff1f8000000000f03f0640", "6699669900aa55aa004411440055aa55", "66886699668150a0004410441100ac5e", "610802010080f0fe1104010001800000", "cece1d39079d375d8c0c180002082208", "0f914298669926010040104010441104", "37dd67ad179d47992208020802480218", "10a814a5349524b510a815a415842590", "04b504b504d552ca0190018001800080", "0a05661a621a621a0045164212421242", "73cd3de11dfd01fd628c30c01ce000fc", "621a621a6216640d1240104212461440", "1de13dc973b5c74d00600c0002000208", "65d572dc76dd76dc2080208822882288", "70c113869c7bf7e7208103061c73c707", "197220012c0c66260000000024046222", "970d07e5370903010208020002000200", "4343c181be3e7e7c4141c080bc3c7870", "010cb0c1e376381e000080402030180e"],
];

        const TEMPLATES = [
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T00
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T01
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T02
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T03
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T04
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 22, 10], [11, null, null, null, 13, 14], [12, null, null, null, 15, 16], [12, null, null, null, 18, 19], [17, null, null, null, 20, 21]],  // T05
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 13], [13, null, null, null, 18, 13], [17, null, null, null, 19, 20]],  // T06
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 20, 10], [11, null, null, null, 13, 14], [12, null, null, null, 15, 12], [12, null, null, null, 17, 12], [16, null, null, null, 18, 19]],  // T07
  [[0, 1, 3, 4, 7, 8], [0, 2, 5, 6, 9, 10], [0, null, null, null, 11, 12], [0, null, null, null, 13, 14], [0, null, null, null, 16, 17], [15, null, null, null, 18, 19]],  // T08
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 13], [13, null, null, null, 18, 13], [17, null, null, null, 19, 20]],  // T09
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T10
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 13], [13, null, null, null, 18, 13], [17, null, null, null, 19, 20]],  // T11
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [0, null, null, null, 12, 13], [0, null, null, null, 14, 15], [0, null, null, null, 17, 18], [16, null, null, null, 19, 20]],  // T12
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [13, null, null, null, 19, 13], [18, null, null, null, 20, 21]],  // T13
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 13, 14], [12, null, null, null, 15, 16], [12, null, null, null, 18, 19], [17, null, null, null, 20, 21]],  // T14
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T15
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T16
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T17
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T18
  [[0, 1, 4, 5, 8, 9], [2, 3, 6, 7, 10, 11], [12, null, null, null, 14, 15], [13, null, null, null, 16, 17], [18, null, null, null, 20, 21], [19, null, null, null, 22, 23]],  // T19
];

        const EYE_TILES = [
  ["1f83909caea0695f00808000a1002940", "ffffee70381c1e9e0000000001c24041", "f8c0083c7c0094fc0701074383039303"],  // E00
  ["1f979d9ea6a86c5f00808080a1206040", "c9fffe79381c1cdf3600000003834200", "f8f8a078f0041cf807070f8703030307"],  // E01
  ["0b819098aca86c5f00008004a2002440", "ffffee70381e5f9f0000000000004140", "d04000001c001cf80302051fe3071307"],  // E02
  ["1f939c9caea0645f00008002a1002440", "ffffee70381c1c9c0000000001400243", "f8c830387c1c80f807070f4783038707"],  // E03
  ["1381909c80a4495f0080848280a44940", "ffffa810381c5ede0000004107420001", "e000003c064898fc030175c301499b03"],  // E04
  ["7f0763793c00307f0000000482039100", "fffcf8e0f378737f000000070c040b00", "e00060f0f83000f81c0e1f0f070f0f07"],  // E05
  ["7f0f67713038207e0000000008858001", "ffff6e6cf078707b0000908001050804", "f0807060f0f018f00c0e0f9e0f07030f"],  // E06
  ["7f7f33713824007e0000000806830101", "fffff8f0f970787b00000001060c0004", "e0e0d0c8e0f018f81e1f0f370f070707"],  // E07
  ["4f0220782005327e0001000000841201", "ffd8c0e1f0717b7d00200000000d0502", "500000e0005038f00c0a371f0f57270f"],  // E08
  ["7f4771703880327e0000000804011201", "fffcf0e1f978727b0000000206040a04", "e000e0f0f00050f81c1e170f0f0f4f07"],  // E09
  ["5f052341bc809c7c0000001402030103", "fff4f8fcf970737b0000000306080804", "e00040a8f87080f00c060503070f0f0f"],  // E10
  ["5f0f02503800247c0000000004812403", "ffffece0f070727b0000000001080a04", "e1800000600060e00d16052b1f076f1f"],  // E11
  ["4f35787c3c22047c0000010002810503", "bfa4d1f8fd78787b4010080702040004", "21c0f0e0f038c8f00d160f1f0f03c50f"],  // E12
  ["5d0422793c00127e0201000402011201", "efcdd0e1f37062771020000e0c081a08", "e10060c0f00050f00d061d3f0f0f4f0f"],  // E13
  ["5f072f5f3a00247d0000000004032502", "fffcfffdf978727b0000000206040a04", "e000c0e0f03848f00c06151b0f07470f"],  // E14
  ["5502402080929e68020100508012ae14", "dda81080102951a82204a04020512853", "500000080492e4a80c061b770395eb57"],  // E15
  ["450201204090a4280200205100102654", "558250a8502051aaaa548840ac582d55", "00000020108020a00402095f0f832f5f"],  // E16
  ["05024120108800202a0500402c162050", "55aa54a8402050eaaa55a800325d2814", "500000081020042887030517efc70b17"],  // E17
  ["05024120001200282a05225800922054", "55ae5ca8502151a8aa51a250225d2e55", "50800008049204a884020b7703910b57"],  // E18
  ["05024100408012382a05026034011218", "5dba44a0502851e8a2452a5020562d17", "50800000040090c084020b1fbb079347"],  // E19
];

        const NOSE_TILES = [
  ["5f5f5f5f5faf2eae0040004000002001", "3ebfb77b796000038000080004049f20", "7834fefefefc7838874b010101030787"],  // N00
  ["5f5f5f5f5f1f1e0c40400040008000a2", "bd7e7b7d7d7000010201000000008f20", "fcf8fefefefe7ebc0307010101010143"],  // N01
  ["5f5f5f5f5f9f1f8f00400040008000a0", "bebf3f797c7081c70100000201000e18", "fc7efefefe7c78b0038101010182854f"],  // N02
  ["3f3f3f3f5e0e2623000000000000200c", "bebf7f7bf9f860010000000004040300", "f43cfcf8f8f060380b030206050b1787"],  // N03
  ["5f5f5f5e5e2d2f2f0040004000802080", "bf7f7dfef26080000000000000000721", "08fcfcfc7c3810d8a70303030387cf27"],  // N04
  ["7e7e7e7d7d7d7e7e0000000000000000", "fbfcfff7f793090e0002000800087641", "f878f8f8f8f8f0e00787070707070b17"],  // N05
  ["7e4c7d7d7d7d7e7e0012000000000000", "fdeee7fbfbc100070210100000041f48", "e040f0f8fcfcf870178f0f0703030387"],  // N06
  ["7c7a7e7d7d79797a0204000000000404", "f9fcfeeff7f3c1040200010000000c03", "f0e078f8f8f8f0e00f1f870707070f1f"],  // N07
  ["7c7e7d7b7b7978740200020404040408", "fefff7f3f98d84020100080402022309", "f8fcfcfcfcfcfc780703030303030383"],  // N08
  ["7c7e7e7d7d7d7d7e0200000000000000", "f9fefff7f3f3810e0200000804000e71", "f878f8f8f8f8f8f80787070707070707"],  // N09
  ["787a7d7d7d7db9ba0400000000000002", "f9fcffeff3f18d7e020000100402087c", "e0ecfcfcfcf8f0f0170301010103070f"],  // N10
  ["7832757d7b73212a0408000000000892", "f9fdfeeff3f1cc3e020000000400093c", "e0cc1cecfcf870301723a301010303cf"],  // N11
  ["7c7a7d7d7b7b393a0000000000000082", "f9fcefe7f3f1841e02000010080a411c", "e0c0f8fcfcf8f0f0172f05010103070f"],  // N12
  ["7c587d7d7d7d3a3b0002000000000203", "fbfceff7f3817cfe00010000040279fc", "e4cc7cfcfcf8f0e0132301010103070e"],  // N13
  ["7c797d7b7b7d3a3b0000000000008203", "f9fcfbfdfcc01efe02000000010118fc", "e0c0f4fcfcf870e0172f09010103871f"],  // N14
  ["74797528552810200a04085528150810", "d0aa45ab518000002954b250a2030000", "5020d4e854a85020af5e2b17aa54aa54"],  // N15
  ["140a7569552894202a54081428500810", "d1aad7ab458001002c542050a8440200", "400054a854a850a0b76eab57aa54aa5c"],  // N16
  ["5468652b512a5120281108502a512850", "d5a2d1a9d5a84000285c22442851a000", "50a004a0d4a85020af5e8b572b56ae5e"],  // N17
  ["74787429552810200a060a5428150850", "44a2d5a2c1800000ba5d2a553261c000", "41aaf5ea54a85020be540a15aa54aa54"],  // N18
  ["50627439552855282c180a4428152850", "d4aac5a3d1a241002a553a5c26558600", "5022d4ea54aa54a8af1d2b15ab54ab57"],  // N19
];

        const MOUTH_TILES = [
  ["0f06162262c088080000100020408808", "0038117ec1e3efe71000000002040000", "48e4e4f2f97c3e1e48ece4f6fbfd7e1e", "4300000440aa60070000000140aa6007", "9858181890b0a080672727262c081002", "0000011364830fd003160d4b04830fd0"],  // M00
  ["00080e2667c28a080040800020408808", "107811feff83c1c70000000000442a00", "4265e1f2797c3e1e48ece4f6fbfd7e1e", "03008080008240070000000100824007", "3800d818b8f8b0a04707272706060d1b", "0000091b64830f00270e156304830fd0"],  // M01
  ["0f0f072763c389080040800020408808", "ffff00fec7c3ffff0000910000380000", "4265e4f27b7d3e1e48ece4f6fbfd7e1e", "ff7f006000be67470000001f00bf674f", "f8f8f878f8f0f0e007070787060c0913", "c000013264030f00071e7dcb04838fd0"],  // M02
  ["0e04000040c180000040800000408000", "0000107e8101cb410000000042660000", "008080c0d0602810008080c0d0e06810", "00000000000000010000000000000001", "38381008800080004402010000000000", "0000001000834f500000001100834f50"],  // M03
  ["0c00100064c288010040800022408800", "0000103a40c1efef0020000000260000", "41e0e4f4787d3e1e40e0e4f4f8fd7e1e", "c7830000000040010000000000004001", "080000008028b09005031d031e060c00", "8000010b24030f500102010b24030f50"],  // M04
  ["3c3c3819590b4b178000800080208020", "43e141f8fc0c863e0000000000100800", "43030102040504048000800204040404", "bf9f2a100000919f00000000030f0e00", "f0f0f0f0f0f0e0e00f0f0f0e0e0f1f17", "c08001113373f7ee2e1e3dedcb8b070e"],  // M05
  ["7d3830293b3b1f1f00808084808480c0", "23d000f90e07af1f0000000010a81000", "0f0703080c05000480d0880400000004", "9f0f03000004839e0000201003080001", "f0f0709030b0f0e00f0f0f0e4e4f0f1f", "e0c001018343870e1e1e3dfd3b3b77ee"],  // M06
  ["3c38385111030b110080004000800810", "03e100f80c041e3c4000000010a80000", "00000042044124040080004204412404", "18002000020414800000200002041480", "f0f0f0d0400000010c0a0c0414100001", "08020141432127ce08020141432127ce"],  // M07
  ["3a30021d090b0f0f0080008024842080", "05c008f1fc1e0fcf000040000101e030", "07070301040404042080000004040404", "fffffffc0000c0ff00000002007f3f00", "f07030f0f0f0e0e0070f0f0e0e0f1d1b", "c08001011333f7ee366e9d7debcb070e"],  // M08
  ["3fbf3c9d5d8f6f970000004042404050", "ffff46f8fe0f879f0000010000100820", "63830102040504044040000204040404", "bf1f2a100001979f00000000030e0800", "f0f0f07070f0e0e00f0f0f8e8e0f1f17", "c080010163e3e7ee2e1e3dfd9b1b170e"],  // M09
  ["3b3b355655626bb30303054644614030", "be570bf1fc0f071ebc160a0100108820", "ba5d395f772f3b55384d095f13031204", "5e6ad56ffffffdea0040d54ffff5f5c0", "f07070a0a202c58e0f0f0d1c1818146c", "1cb6faf8feed73aa5cb4f0f040400000"],  // M10
  ["372e0f5d5a7a7937070e0f58587071b7", "ffff2f57eb13024dfefe2f0703e1104c", "3f7f3d6f6b2b29451f5f3425090a0040", "bfff7ffffd5d554abeff7fd7d1501008", "78b9b3cedefefdf6020002868cbcd4f4", "7cf6dad8d44973a278e048c040010382"],  // M11
  ["271f350c1113030d071e348800840482", "bf570af10c87df5f3e07000010080000", "2722292b2a5555580000090b0a141418", "2fa7bbfcfaec60a820a0b0d858684103", "20c0e010109091a11b07cf0f0e4e4d5d", "22c285850b0b17b69a3265152b6bd736"],  // M12
  ["37170f0e0c4e5c7907262e2c2c485870", "be5f1fef0b07855b3c1e1e0fe3170141", "3c392b5f5d1f2f57a4092b4f55172a52", "e9d2f7fbf7ffffebe0d2a7ebf7be9a88", "c07071b0b2d2d5ae3f0e0c0c0a8884a8", "dcdaf9e9f3e3a7cedc90f1e1a383870e"],  // M13
  ["37372d5e7c79723b07060c5c797a7038", "be570b7109049e3e3c560b8115aa0100", "2a1d2b0f070f0b15a8192b0f050d0b15", "5e6ad57ffffffefa4060d57ffefa5a50", "f071b3c6fefe3f3a0e0c0a84dcfc38b8", "7cd8e8c1614347ae78d0e2810503070e"],  // M14
  ["00008000010201820000800002050281", "000040e0500a042800400000a8158a14", "80028102000040008200800000008000", "14080000000000002a14080000000000", "10000000000000002810000000000000", "00020100020103060002010002010306"],  // M15
  ["00008020112a158a000080010a050a85", "000000f85402012a00402004aa1d8e15", "04018200000000000a05020000c08080", "150a0100000000002a14080000000000", "0000002050a040a00204060c08589040", "40800000000000008002000002010206"],  // M16
  ["5022842b012a158b0000a0102a040294", "40a841e8540201aa00400014aa0d2e15", "970a040100c080808805020100804080", "550a0502000000002a152a0500000000", "10001082508004002a3c0c7a8858b470", "0082000002010206e062c10002000102"],  // M17
  ["10200021052205802051200022052a85", "000840ea050245aa506000101aadba51", "85038102000000000a0002010040c000", "d5a854a8500000002851a85480000000", "50200020002000202a5834143818b000", "00000000000000008002010000010106"],  // M18
  ["50204120012a148a2051224428152b95", "00085400f402010a5060aa41085d8e55", "9509850000c0c0908a04000100000010", "d4aa54a8100000002a55aa55a8000000", "50281408042850a02f172b170b56ae5c", "40a2410002051316b852810002051316"],  // M19
];

        // Decode NES tile from hex string (16 bytes = 32 hex chars)
        function decodeTile(hexStr) {
            const bytes = [];
            for (let i = 0; i < 32; i += 2) {
                bytes.push(parseInt(hexStr.substr(i, 2), 16));
            }
            const pixels = [];
            for (let y = 0; y < 8; y++) {
                const row = [];
                const plane0 = bytes[y];
                const plane1 = bytes[y + 8];
                for (let x = 7; x >= 0; x--) {
                    const bit0 = (plane0 >> x) & 1;
                    const bit1 = (plane1 >> x) & 1;
                    row.push(bit0 + (bit1 << 1));
                }
                pixels.push(row);
            }
            return pixels;
        }

        // Draw a single tile on canvas at (x, y) with given scale
        function drawTile(ctx, hexStr, x, y, scale) {
            const pixels = decodeTile(hexStr);
            for (let py = 0; py < 8; py++) {
                for (let px = 0; px < 8; px++) {
                    const colorIdx = pixels[py][px];
                    const [r, g, b] = PALETTE[colorIdx];
                    ctx.fillStyle = `rgb(${r},${g},${b})`;
                    ctx.fillRect(x + px * scale, y + py * scale, scale, scale);
                }
            }
        }

        // Draw multiple tiles horizontally
        function drawTilesHorizontal(ctx, tiles, x, y, scale) {
            tiles.forEach((tile, i) => {
                drawTile(ctx, tile, x + i * 8 * scale, y, scale);
            });
        }

        // Draw 6 mouth tiles in 3x2 grid
        function drawMouthTiles(ctx, tiles, x, y, scale) {
            // Layout: [0,1,4], [2,3,5]
            const layout = [[0, 1, 4], [2, 3, 5]];
            for (let row = 0; row < 2; row++) {
                for (let col = 0; col < 3; col++) {
                    const tileIdx = layout[row][col];
                    drawTile(ctx, tiles[tileIdx], x + col * 8 * scale, y + row * 8 * scale, scale);
                }
            }
        }

        // Create a canvas element with tiles rendered
        function createTileCanvas(tiles, width, height, scale) {
            const canvas = document.createElement('canvas');
            canvas.width = width * scale;
            canvas.height = height * scale;
            canvas.style.imageRendering = 'pixelated';
            const ctx = canvas.getContext('2d');

            if (height === 16) {
                // Mouth tiles (3x2 grid)
                drawMouthTiles(ctx, tiles, 0, 0, scale);
            } else {
                // Eye or nose tiles (horizontal)
                drawTilesHorizontal(ctx, tiles, 0, 0, scale);
            }
            return canvas;
        }

        // === EMBEDDED DATA END ===

        // Current selection state
        let currentHead = 0;  // global index 0-19
        let currentEyes = 0;  // local index 0-4
        let currentNoses = 0; // local index 0-4
        let currentMouths = 0; // local index 0-4
        let showGrid = false; // toggle for tile grid lines

        // Computed category from head
        function getCurrentCat() {
            return Math.floor(currentHead / 5);
        }

        // Toggle grid display
        function toggleGrid() {
            showGrid = !showGrid;
            document.getElementById('grid-btn').textContent = showGrid ? '隱藏格線' : '顯示格線';
            updatePreview();
        }

        // Image cache
        // Known combinations from the game
                const KNOWN_COMBINATIONS = [
            // Category 0
            { name: "高沛", pid: "P138", cat: 0, h: 0, e: 2, n: 3, m: 1 },
            { name: "孫瑜", pid: "P083", cat: 0, h: 1, e: 2, n: 1, m: 2 },
            { name: "高覽", pid: "P097", cat: 0, h: 1, e: 3, n: 1, m: 2 },
            { name: "袁譚", pid: "P099", cat: 0, h: 2, e: 0, n: 1, m: 2 },
            { name: "袁熙", pid: "P100", cat: 0, h: 2, e: 2, n: 1, m: 2 },
            { name: "馬鐵", pid: "P146", cat: 0, h: 2, e: 1, n: 0, m: 0 },
            { name: "程銀", pid: "P148", cat: 0, h: 2, e: 3, n: 0, m: 0 },
            { name: "李堪", pid: "P149", cat: 0, h: 3, e: 2, n: 3, m: 1 },
            { name: "張允", pid: "P117", cat: 0, h: 4, e: 4, n: 4, m: 3 },
            { name: "蔡和", pid: "P118", cat: 0, h: 4, e: 3, n: 4, m: 3 },
            { name: "蔡中", pid: "P119", cat: 0, h: 4, e: 1, n: 4, m: 3 },
            // Category 1
            { name: "陳琳", pid: "P092", cat: 1, h: 0, e: 3, n: 1, m: 2 },
            { name: "田豐", pid: "P093", cat: 1, h: 0, e: 4, n: 2, m: 4 },
            { name: "沮授", pid: "P095", cat: 1, h: 0, e: 4, n: 3, m: 1 },
            { name: "法正", pid: "P131", cat: 1, h: 1, e: 2, n: 3, m: 1 },
            { name: "鄧賢", pid: "P135", cat: 1, h: 1, e: 3, n: 1, m: 2 },
            { name: "張昭", pid: "P165", cat: 1, h: 1, e: 4, n: 3, m: 1 },
            { name: "張紘", pid: "P166", cat: 1, h: 1, e: 4, n: 3, m: 3 },
            { name: "闞澤", pid: "P189", cat: 1, h: 2, e: 2, n: 2, m: 2 },
            { name: "韓玄", pid: "P204", cat: 1, h: 3, e: 0, n: 0, m: 0 },
            { name: "鞏志", pid: "P211", cat: 1, h: 3, e: 0, n: 1, m: 3 },
            // Category 2
            { name: "黃祖", pid: "P111", cat: 2, h: 0, e: 2, n: 1, m: 2 },
            { name: "李傕", pid: "P121", cat: 2, h: 0, e: 3, n: 4, m: 3 },
            { name: "蔡邕", pid: "P122", cat: 2, h: 0, e: 4, n: 2, m: 4 },
            { name: "郭汜", pid: "P123", cat: 2, h: 1, e: 0, n: 1, m: 2 },
            { name: "張濟", pid: "P124", cat: 2, h: 1, e: 1, n: 4, m: 3 },
            { name: "徐榮", pid: "P127", cat: 2, h: 1, e: 3, n: 0, m: 0 },
            { name: "董旻", pid: "P130", cat: 2, h: 1, e: 4, n: 3, m: 1 },
            { name: "虞翻", pid: "P168", cat: 2, h: 3, e: 3, n: 0, m: 0 },
            // Category 3
            { name: "周泰", pid: "P081", cat: 3, h: 0, e: 2, n: 3, m: 1 },
            { name: "孫翊", pid: "P082", cat: 3, h: 0, e: 3, n: 4, m: 3 },
            { name: "孫桓", pid: "P084", cat: 3, h: 0, e: 3, n: 0, m: 0 },
            { name: "李肅", pid: "P120", cat: 3, h: 1, e: 2, n: 2, m: 4 },
            { name: "華雄", pid: "P125", cat: 3, h: 1, e: 2, n: 0, m: 1 },
            { name: "胡軫", pid: "P128", cat: 3, h: 1, e: 3, n: 4, m: 3 },
            { name: "趙岑", pid: "P129", cat: 3, h: 1, e: 3, n: 0, m: 0 },
            { name: "侯選", pid: "P147", cat: 3, h: 2, e: 0, n: 0, m: 0 },
            { name: "張橫", pid: "P150", cat: 3, h: 2, e: 0, n: 1, m: 2 },
            { name: "周倉", pid: "P186", cat: 3, h: 2, e: 4, n: 2, m: 4 },
            { name: "糜芳", pid: "P182", cat: 3, h: 3, e: 0, n: 0, m: 0 },
            { name: "徐盛", pid: "P195", cat: 3, h: 3, e: 1, n: 4, m: 3 },
            { name: "文聘", pid: "P214", cat: 3, h: 3, e: 3, n: 1, m: 2 },
            { name: "傅士仁", pid: "P185", cat: 3, h: 4, e: 0, n: 1, m: 2 },
        ];

        // Head info array (template index, baseAddr, tileCount, grid)
        const HEADS = [
            { idx: 0, template: 0, baseAddr: "0x1c014", tileCount: 24, grid: TEMPLATES[0] },
            { idx: 1, template: 1, baseAddr: "0x1c194", tileCount: 24, grid: TEMPLATES[1] },
            { idx: 2, template: 2, baseAddr: "0x1c314", tileCount: 24, grid: TEMPLATES[2] },
            { idx: 3, template: 3, baseAddr: "0x1c494", tileCount: 24, grid: TEMPLATES[3] },
            { idx: 4, template: 4, baseAddr: "0x1c614", tileCount: 24, grid: TEMPLATES[4] },
            { idx: 5, template: 5, baseAddr: "0x1c794", tileCount: 24, grid: TEMPLATES[5] },
            { idx: 6, template: 6, baseAddr: "0x1c914", tileCount: 24, grid: TEMPLATES[6] },
            { idx: 7, template: 7, baseAddr: "0x1ca94", tileCount: 24, grid: TEMPLATES[7] },
            { idx: 8, template: 8, baseAddr: "0x1cc14", tileCount: 24, grid: TEMPLATES[8] },
            { idx: 9, template: 9, baseAddr: "0x1cd94", tileCount: 24, grid: TEMPLATES[9] },
            { idx: 10, template: 10, baseAddr: "0x1cf14", tileCount: 24, grid: TEMPLATES[10] },
            { idx: 11, template: 11, baseAddr: "0x1d094", tileCount: 24, grid: TEMPLATES[11] },
            { idx: 12, template: 12, baseAddr: "0x1d214", tileCount: 24, grid: TEMPLATES[12] },
            { idx: 13, template: 13, baseAddr: "0x1d394", tileCount: 24, grid: TEMPLATES[13] },
            { idx: 14, template: 14, baseAddr: "0x1d514", tileCount: 24, grid: TEMPLATES[14] },
            { idx: 15, template: 15, baseAddr: "0x1d694", tileCount: 24, grid: TEMPLATES[15] },
            { idx: 16, template: 16, baseAddr: "0x1d814", tileCount: 24, grid: TEMPLATES[16] },
            { idx: 17, template: 17, baseAddr: "0x1d994", tileCount: 24, grid: TEMPLATES[17] },
            { idx: 18, template: 18, baseAddr: "0x1db14", tileCount: 24, grid: TEMPLATES[18] },
            { idx: 19, template: 19, baseAddr: "0x1dc94", tileCount: 24, grid: TEMPLATES[19] },
        ];

        // Head to Pattern mapping
        const HEAD_TO_PATTERN = {
            0: 1, 1: 1, 2: 1, 3: 1, 4: 1,  // H00-H04: P1 (24-tile)
            5: 2, 6: 3, 7: 4, 8: 5,        // H05-H08
            9: 3, 10: 1, 11: 3,            // H09-H11
            12: 6, 13: 7, 14: 8,           // H12-H14
            15: 1, 16: 1, 17: 1, 18: 1, 19: 1,  // H15-H19: P1 (24-tile)
        };

        // Pattern descriptions
        const PATTERN_DESC = {
            1: "P1 (標準 24-tile)",
            2: "P2 (tile 12 重複)",
            3: "P3 (tile 13 重複)",
            4: "P4 (tile 12 重複)",
            5: "P5 (tile 0 重複)",
            6: "P6 (tile 0 重複)",
            7: "P7 (tile 13 重複)",
            8: "P8 (tile 12 重複)",
        };

        // Draw head preview on a canvas
        function drawHeadPreview(canvas, headIdx) {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const template = TEMPLATES[headIdx];
            const headTiles = HEAD_TILES[headIdx];
            const scale = Math.floor(canvas.width / 48);

            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 6; col++) {
                    const tileIdx = template[row][col];
                    if (tileIdx !== null && tileIdx < headTiles.length) {
                        drawTile(ctx, headTiles[tileIdx], col * 8 * scale, row * 8 * scale, scale);
                    }
                }
            }
        }

        // Initialize selectors
        function initSelectors() {
            // Head buttons (20 global buttons: H00-H19)
            const headSelector = document.getElementById('head-selector');
            const preview = document.getElementById('head-preview');
            const previewCanvas = document.getElementById('head-preview-canvas');
            const previewLabel = document.getElementById('head-preview-label');

            for (let i = 0; i < 20; i++) {
                const btn = document.createElement('button');
                btn.className = 'head-btn' + (i === 0 ? ' selected' : '');
                btn.textContent = `H${i.toString().padStart(2, '0')}`;
                btn.onclick = () => selectHead(i);

                // Hover preview
                btn.onmouseenter = (e) => {
                    drawHeadPreview(previewCanvas, i);
                    previewLabel.textContent = `H${i.toString().padStart(2, '0')} (Cat ${Math.floor(i / 5)})`;
                    preview.style.display = 'block';
                    preview.style.left = (e.pageX + 15) + 'px';
                    preview.style.top = (e.pageY + 15) + 'px';
                };
                btn.onmousemove = (e) => {
                    preview.style.left = (e.pageX + 15) + 'px';
                    preview.style.top = (e.pageY + 15) + 'px';
                };
                btn.onmouseleave = () => {
                    preview.style.display = 'none';
                };

                headSelector.appendChild(btn);
            }

            // Variant selectors (local 0-4) - initialized for category 0
            updateVariantSelectors();

            // Known combinations
            initKnownList();
        }

        function updateVariantSelectors() {
            // Update all variant selectors based on current category
            updateVariantSelector('eyes', EYE_TILES);
            updateVariantSelector('noses', NOSE_TILES);
            updateVariantSelector('mouths', MOUTH_TILES);
        }

        function updateVariantSelector(type, tilesArr) {
            const container = document.getElementById(`${type}-selector`);
            container.innerHTML = ''; // Clear existing
            const isMouth = type === 'mouths';
            const baseIdx = getCurrentCat() * 5;
            const currentVal = type === 'eyes' ? currentEyes : (type === 'noses' ? currentNoses : currentMouths);

            for (let i = 0; i < 5; i++) {
                const globalIdx = baseIdx + i;
                const item = document.createElement('div');
                item.className = 'variant-item' + (i === currentVal ? ' selected' : '');

                const tiles = tilesArr[globalIdx];
                const canvas = createTileCanvas(tiles, 24, isMouth ? 16 : 8, 3);
                item.appendChild(canvas);

                const span = document.createElement('span');
                span.textContent = `#${i}`;
                item.appendChild(span);

                item.onclick = () => selectVariant(type, i);
                container.appendChild(item);
            }
        }

        function initKnownList() {
            const container = document.getElementById('known-list');
            KNOWN_COMBINATIONS.forEach(combo => {
                const item = document.createElement('div');
                item.className = 'known-item';
                item.innerHTML = `
                    <span class="name">${combo.name}</span>
                    <span class="idx">${combo.pid} | C${combo.cat} H${combo.h}</span>
                `;
                item.onclick = () => loadKnownCombo(combo);
                container.appendChild(item);
            });
        }

        function selectHead(globalIdx) {
            const oldCat = getCurrentCat();
            currentHead = globalIdx;
            const newCat = getCurrentCat();

            // Update head button selection
            document.querySelectorAll('#head-selector .head-btn').forEach((btn, i) => {
                btn.classList.toggle('selected', i === globalIdx);
            });

            // If category changed, reset variant indices and update variant selectors
            if (oldCat !== newCat) {
                currentEyes = 0;
                currentNoses = 0;
                currentMouths = 0;
                updateVariantSelectors();
            }

            updatePreview();
            updateInfo();
        }

        function selectVariant(type, idx) {
            if (type === 'eyes') currentEyes = idx;
            else if (type === 'noses') currentNoses = idx;
            else if (type === 'mouths') currentMouths = idx;

            const container = document.getElementById(`${type}-selector`);
            container.querySelectorAll('.variant-item').forEach((item, i) => {
                item.classList.toggle('selected', i === idx);
            });
            updatePreview();
            updateInfo();
        }

        function loadKnownCombo(combo) {
            // Convert category-local indices to global head
            const globalHead = combo.cat * 5 + combo.h;
            selectHead(globalHead);
            selectVariant('eyes', combo.e);
            selectVariant('noses', combo.n);
            selectVariant('mouths', combo.m);
        }

        function updatePreview() {
            const canvas = document.getElementById('portrait-canvas');
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;

            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 288, 288);

            const scale = 6;
            const cat = getCurrentCat();

            // Calculate global indices for variants
            const globalEyes = cat * 5 + currentEyes;
            const globalNoses = cat * 5 + currentNoses;
            const globalMouths = cat * 5 + currentMouths;

            // Draw head framework using TEMPLATES and HEAD_TILES
            const template = TEMPLATES[currentHead];
            const headTiles = HEAD_TILES[currentHead];

            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 6; col++) {
                    const tileIdx = template[row][col];
                    if (tileIdx !== null && tileIdx < headTiles.length) {
                        drawTile(ctx, headTiles[tileIdx], col * 8 * scale, row * 8 * scale, scale);
                    }
                }
            }

            // Draw variants in their positions
            // Eyes go in row 2, columns 1-3
            drawTilesHorizontal(ctx, EYE_TILES[globalEyes], 8 * scale, 16 * scale, scale);

            // Noses go in row 3, columns 1-3
            drawTilesHorizontal(ctx, NOSE_TILES[globalNoses], 8 * scale, 24 * scale, scale);

            // Mouths go in rows 4-5, columns 1-3
            drawMouthTiles(ctx, MOUTH_TILES[globalMouths], 8 * scale, 32 * scale, scale);

            // Draw grid lines and labels if enabled
            if (showGrid) {
                const tileSize = 8 * scale; // 48px per tile
                const grid = TEMPLATES[currentHead];

                // Draw grid lines in red
                ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)';
                ctx.lineWidth = 2;
                // Vertical lines
                for (let i = 1; i < 6; i++) {
                    ctx.beginPath();
                    ctx.moveTo(i * tileSize, 0);
                    ctx.lineTo(i * tileSize, 288);
                    ctx.stroke();
                }
                // Horizontal lines
                for (let i = 1; i < 6; i++) {
                    ctx.beginPath();
                    ctx.moveTo(0, i * tileSize);
                    ctx.lineTo(288, i * tileSize);
                    ctx.stroke();
                }

                // Draw labels in each cell
                ctx.font = 'bold 14px monospace';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                for (let row = 0; row < 6; row++) {
                    for (let col = 0; col < 6; col++) {
                        const val = grid[row][col];
                        let label;
                        if (val === null) {
                            label = getVariantLabel(row, col) || '?';
                            ctx.fillStyle = 'rgba(255, 255, 0, 0.9)'; // Yellow for variants
                        } else {
                            label = val.toString();
                            ctx.fillStyle = 'rgba(255, 100, 100, 0.9)'; // Light red for fixed tiles
                        }
                        const x = col * tileSize + tileSize / 2;
                        const y = row * tileSize + tileSize / 2;
                        // Draw text shadow for visibility
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                        ctx.lineWidth = 3;
                        ctx.strokeText(label, x, y);
                        ctx.fillText(label, x, y);
                    }
                }
            }
        }

        function updateInfo() {
            const cat = getCurrentCat();
            const localHead = currentHead % 5;
            const head = HEADS[currentHead];
            const pattern = HEAD_TO_PATTERN[currentHead];

            document.getElementById('info-cat').textContent = cat;
            document.getElementById('info-head').textContent = localHead;
            document.getElementById('info-head-global').textContent = currentHead.toString().padStart(2, '0');
            document.getElementById('info-template').textContent = `T${head.template.toString().padStart(2, '0')}`;
            document.getElementById('info-eyes').textContent = currentEyes;
            document.getElementById('info-noses').textContent = currentNoses;
            document.getElementById('info-mouths').textContent = currentMouths;

            document.getElementById('info-base-addr').textContent = head.baseAddr;
            document.getElementById('info-tile-count').textContent = head.tileCount;
            document.getElementById('info-pattern').textContent = PATTERN_DESC[pattern] || `P${pattern}`;

            // Update template visualization
            updateTemplateVis(head.grid);
        }

        // Get variant label for a specific grid position
        function getVariantLabel(row, col) {
            if (col < 1 || col > 3) return null;
            if (row === 2) return `E${col - 1}`; // Eyes: E0, E1, E2
            if (row === 3) return `N${col - 1}`; // Nose: N0, N1, N2
            if (row === 4) return `M${[0, 1, 4][col - 1]}`; // Mouth row 1: M0, M1, M4
            if (row === 5) return `M${[2, 3, 5][col - 1]}`; // Mouth row 2: M2, M3, M5
            return null;
        }

        function updateTemplateVis(grid) {
            const container = document.getElementById('template-vis');
            container.innerHTML = '';
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 6; col++) {
                    const cell = document.createElement('div');
                    const val = grid[row][col];
                    cell.className = 'template-cell' + (val === null ? ' variant' : '');
                    if (val === null) {
                        cell.textContent = getVariantLabel(row, col) || '?';
                    } else {
                        cell.textContent = val;
                    }
                    container.appendChild(cell);
                }
            }
        }

        function randomize() {
            // Randomize global head (0-19), then local variant indices (0-4)
            selectHead(Math.floor(Math.random() * 20));
            selectVariant('eyes', Math.floor(Math.random() * 5));
            selectVariant('noses', Math.floor(Math.random() * 5));
            selectVariant('mouths', Math.floor(Math.random() * 5));
        }

        function downloadPortrait() {
            const canvas = document.getElementById('portrait-canvas');
            const link = document.createElement('a');
            const cat = getCurrentCat();
            const localHead = currentHead % 5;
            link.download = `portrait_C${cat}_H${localHead}_E${currentEyes}_N${currentNoses}_M${currentMouths}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // Initialize on load
        window.onload = () => {
            initSelectors();
            updatePreview();
            updateInfo();
        };
        </script>
</body>
</html>
